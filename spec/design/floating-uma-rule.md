# 浮きウマ設計仕様（最終設計方針）

## 1. 概要

本ドキュメントは、麻雀アプリにおける「浮きウマ（順位ウマ）」ルールの最終設計方針を定義する。
本仕様は4人麻雀を基本として説明するが、3人麻雀でも同様の考え方で実装可能としている。

浮きウマとは、**基準点（返し点）を超えて終局したプレイヤー数（＝浮き人数）に応じて順位点を変動させるルール**である。
このルールはMリーグや日本プロ麻雀連盟のような**競技ルールにも存在する**ため、実装価値が高い。

---

## 2. 前提条件と用語定義

| 項目           | 意味                  | 例                       |
| ------------ | ------------------- | ----------------------- |
| **開始点**      | 対局開始時の持ち点           | 30,000点 など              |
| **基準点（返し点）** | 精算時の±0とする点数（浮き判定点）  | 30,000点 など              |
| **浮き人数**     | 基準点以上のプレイヤー数        | 例：2人浮き ＝ 2名が30,000点以上   |
| **ウマ配列**     | 浮き人数ごとの順位点配分（順位1〜4） | [＋20, ＋10, −10, −20] など |

---

## 3. 浮き人数と配列数の対応

浮き人数の取り得る範囲は「開始点と基準点の関係」によって変わる。

| 条件                | 浮き人数の範囲 | 必要なウマ配列数 | 備考                           |
| ----------------- | ------- | -------- | ---------------------------- |
| **開始点＝基準点（オカなし）** | 1〜4     | 4配列      | 全員原点は「全員浮き」とみなすため、0人浮きは存在しない |
| **開始点＜基準点（返しあり）** | 0〜3     | 4配列      | 全員沈み（0人浮き）はあり、全員浮きは存在しない     |

※ 浮き人数は理論上5通り（0〜4）だが、
　実際に使用されるのは常に4パターンのみとなる。

---

## 4. データ設計方針

内部構造は **0〜4の5キーを持つMap形式** とし、
未使用キーは `[0,0,0,0]` などの無効値で0埋めして保持する。

これにより：

* コードロジックを単純化できる（常にキーが存在する）
* UI側で不要な入力を非表示化できる
* 将来的な拡張（特殊ルール）が容易になる

### 構造イメージ（4人麻雀）

```json
"floatingUmaTable": {
  "0": [0, 0, 0, 0],        // 全員沈み（開始<基準のときのみ有効）
  "1": [20, -5, -5, -10],   // 1人浮き
  "2": [15, 5, -5, -15],    // 2人浮き
  "3": [10, 5, -5, -10],    // 3人浮き
  "4": [0, 0, 0, 0]         // 全員浮き（開始=基準のときのみ有効）
}
```

UI上では、開始点と基準点を登録した段階で：

* 不要な配列（0 or 4）を読み取り専用 or 非表示にする。
* これによりユーザの入力負担を削減する。

---

## 5. 浮き判定ロジック

浮きの基準は常に「**基準点（返し点）**」で行う。

```python
def is_floating(score, base_points):
    return score >= base_points
```

* 「開始点＝基準点」の場合でも、浮き判定は基準点で統一。
* 将来的に返し点を変えるルールが出てもロジック変更不要。

---

## 6. 精算ロジックの概要

順位ウマ算出は以下の流れで行う：

1. 各プレイヤーの浮き判定
   → `score >= basePoints`
2. 浮き人数を入力
   ※一人成績管理の場合、他のポイントはわからないためユーザ入力が必須
3. 浮き人数に対応するウマ配列を取得
   → `uma = floatingUmaTable[str(floaters)]`
4. 自身の順位に応じたウマを加算
   → `playerPoints += uma[playerRank - 1]`

---

## 7. 表現例

### 開始点＝基準点（オカなし）& 4人麻雀

| 浮き人数 | ウマ配列（1〜4位）       | 備考         |
| ---- | ---------------- | ---------- |
| 1人   | ＋12, −1, −3, −8 | トップのみ浮き    |
| 2人   | ＋8, ＋4, −4, −8 | 上位2人浮き     |
| 3人   | ＋8, ＋3, −1, −12 | 上位3人浮き     |
| 4人   | ＋0, ＋0, +0, +0   | 全員浮き（全員原点） |

### 開始点＜基準点（返しあり・オカあり） & 3人麻雀

| 浮き人数 | ウマ配列（1〜4位）       | 備考       |
| ---- | ---------------- | -------- |
| 0人   | 0, 0, 0       | 全員沈み |
| 1人   | ＋40, −20, −20 | トップのみ浮き  |
| 2人   | ＋20, ＋0, −20 | 上位2人浮き   |

---

## 8. 実装方針まとめ

| 観点         | 方針                      |
| ---------- | ----------------------- |
| **項目数**    | 開始点・基準点・浮きウマMap（5キー固定）  |
| **浮き判定点**  | 基準点と同義。別項目不要。           |
| **配列構成**   | 常に0〜4キーを保持。未使用キーは0埋め。   |
| **UI仕様**   | 不要行は自動非表示 or 読み取り専用。    |
| **3人麻雀対応** | 0〜3キーで同構造を再利用。          |
| **拡張性**    | 特殊ルール（例：浮き点カスタム）にも対応可能。 |

---

## 9. 備考

* トビウマや役満ご祝儀などは本ルール外。
* 成績入力時は最終スコア（ウマ・オカ・祝儀込み）を基本とし、
  自動計算は「順位＋素点入力」と「順位のみ（仮ポイント）」のときに行う。
* 浮きウマは競技ルール再現・グループ分析の両面で有用なため、
  今回のスコープに含める。
