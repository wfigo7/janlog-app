# 対局データ包括的バリデーション - 要件定義

## Introduction

対局データの入力時に、単一項目だけでなく複数項目を組み合わせた「麻雀成績としてありえない」状態を検出し、ユーザーの大切な成績データを守るための包括的バリデーション機能を実装します。

## Glossary

- **System**: Janlogアプリケーション（フロントエンド・バックエンド）
- **Match Data**: 対局データ（日時、順位、ポイント、素点等）
- **Entry Method**: 入力方式（Mode 1: 順位+最終ポイント、Mode 2: 順位+素点、Mode 3: 仮ポイント）
- **Floating Uma**: 浮きウマルール（素点が基準点以上かどうかで適用されるウマが変わる）
- **Fixed Uma**: 固定ウマルール（順位のみでウマが決まる）
- **Base Point**: 基準点（返し点、浮き判定点）
- **Start Point**: 開始点（配給原点）
- **Raw Score**: 素点（麻雀の点数、下2桁が00）
- **Final Points**: 最終ポイント（ウマ・オカ計算後のポイント）
- **Floating Count**: 浮き人数（素点が基準点以上のプレイヤー数）
- **Validation Error**: バリデーションエラー（入力データの矛盾を示すエラー）

## Requirements

### Requirement 1: 単一項目バリデーション

**User Story:** 対局データを入力するユーザーとして、各項目の基本的な形式や範囲が正しいことを確認したい。これにより、明らかな入力ミスを早期に発見できる。

#### Acceptance Criteria

1. WHEN ユーザーが対局日を入力する時、THE System SHALL 日付がISO 8601形式であることを検証する
2. WHEN ユーザーが対局日を入力する時、THE System SHALL 日付が未来でないことを検証する
3. WHEN ユーザーが対局日を入力する時、THE System SHALL 日付が5年以上前でないことを検証する
4. WHEN ユーザーが順位を入力する時、THE System SHALL 順位が1以上であることを検証する
5. WHEN ユーザーが順位を入力する時、THE System SHALL 順位がゲームモード（3麻は3、4麻は4）以下であることを検証する
6. WHEN ユーザーが最終ポイントを入力する時、THE System SHALL ポイントが-999.9から999.9の範囲内であることを検証する
7. WHEN ユーザーが最終ポイントを入力する時、THE System SHALL ポイントが小数第1位までであることを検証する
8. WHEN ユーザーが素点を入力する時、THE System SHALL 素点が-999900から999900の範囲内であることを検証する
9. WHEN ユーザーが素点を入力する時、THE System SHALL 素点の下2桁が00であることを検証する
10. WHEN ユーザーがチップ数を入力する時、THE System SHALL チップ数が0以上であることを検証する
11. WHEN ユーザーが浮き人数を入力する時、THE System SHALL 浮き人数が0以上であることを検証する
12. WHEN ユーザーが浮き人数を入力する時、THE System SHALL 浮き人数がゲームモード人数以下であることを検証する

### Requirement 2: 入力方式とルールの整合性バリデーション

**User Story:** 対局データを入力するユーザーとして、選択したルールと入力方式が整合していることを確認したい。これにより、ルール設定ミスによる計算エラーを防げる。

#### Acceptance Criteria

1. WHEN ユーザーが固定ウマルールを選択し、かつ浮き人数を入力する時、THE System SHALL エラーを表示する
2. WHEN ユーザーが浮きウマルールを選択し、かつMode 2（順位+素点）で入力する時、THE System SHALL 浮き人数が必須であることを検証する
3. WHEN ユーザーが浮きウマルールを選択し、かつMode 3（仮ポイント）で入力する時、THE System SHALL 浮き人数が必須であることを検証する
4. WHEN ユーザーがMode 1（順位+最終ポイント）で入力する時、THE System SHALL 最終ポイントが必須であることを検証する
5. WHEN ユーザーがMode 2（順位+素点）で入力する時、THE System SHALL 素点が必須であることを検証する
6. WHEN ユーザーがMode 3（仮ポイント）で入力する時、THE System SHALL 順位のみが必須であることを検証する

### Requirement 3: 浮き人数の存在可能性バリデーション

**User Story:** 浮きウマルールで対局データを入力するユーザーとして、開始点と基準点の関係から論理的にありえない浮き人数を入力できないようにしたい。これにより、ルール理解の誤りによるデータ破損を防げる。

#### Acceptance Criteria

1. WHEN 開始点が基準点と等しく、かつ浮き人数が0である時、THE System SHALL エラーを表示する
2. WHEN 開始点が基準点より小さく、かつ浮き人数がゲームモード人数と等しい時、THE System SHALL エラーを表示する
3. WHEN 開始点が基準点と等しく、かつ浮き人数が1未満である時、THE System SHALL エラーを表示する
4. WHEN 開始点が基準点より小さく、かつ浮き人数がゲームモード人数より大きい時、THE System SHALL エラーを表示する

### Requirement 4: 自分の素点と浮き人数の整合性バリデーション

**User Story:** 浮きウマルールで素点を入力するユーザーとして、自分の素点と浮き人数の関係が矛盾していないことを確認したい。これにより、浮き人数の入力ミスを検出できる。

#### Acceptance Criteria

1. WHEN 自分の素点が基準点以上であり、かつ浮き人数が0である時、THE System SHALL エラーを表示する
2. WHEN 自分の素点が基準点未満であり、かつ浮き人数がゲームモード人数と等しい時、THE System SHALL エラーを表示する
3. WHEN 開始点が基準点と等しく、かつ浮き人数が1未満である時、THE System SHALL エラーを表示する
4. WHEN 開始点が基準点より小さく、かつ浮き人数がゲームモード人数-1より大きい時、THE System SHALL エラーを表示する

### Requirement 5: 順位と素点の関係バリデーション

**User Story:** 素点を入力するユーザーとして、順位と素点の関係が明らかに矛盾していないことを確認したい。これにより、順位または素点の入力ミスを検出できる。

**補足:** 全員同点の場合は座順で順位が決まるため、基準点=素点でも1位や最下位が成立します。

#### Acceptance Criteria

1. WHEN 浮きウマルールを使用し、かつ順位が1位であり、かつ浮き人数が2以上であり、かつ素点が基準点未満である時、THE System SHALL エラーを表示する
2. WHEN 浮きウマルールを使用し、かつ順位が最下位であり、かつ浮き人数が（ゲームモード人数-2）以下であり、かつ素点が基準点より大きい時、THE System SHALL エラーを表示する
3. WHEN 浮きウマルールを使用し、かつ開始点が基準点より小さく、かつ順位が最下位であり、かつ素点が基準点より大きい時、THE System SHALL エラーを表示する
4. WHEN 浮きウマルールを使用し、かつ開始点が基準点と等しく、かつ浮き人数がゲームモード人数であり、かつ素点が基準点未満である時、THE System SHALL エラーを表示する
5. WHEN 浮きウマルールを使用し、かつ開始点が基準点より小さく、かつ浮き人数が0であり、かつ素点が基準点以上である時、THE System SHALL エラーを表示する
6. WHEN 固定ウマルールを使用し、かつMode 2（順位+素点）で入力し、かつ素点が明らかに順位と矛盾する時、THE System SHALL 警告を表示する

### Requirement 6: 最終ポイントとルールの整合性バリデーション

**User Story:** 最終ポイントを入力するユーザーとして、入力したポイントがルール設定から計算可能な範囲内であることを確認したい。これにより、明らかに不正なポイント入力を検出できる。

#### Acceptance Criteria

1. WHEN ユーザーがMode 2（順位+素点）で入力し、かつ計算された最終ポイントが-999.9から999.9の範囲外である時、THE System SHALL エラーを表示する
2. WHEN ユーザーがMode 2（順位+素点）で入力し、かつ計算された最終ポイントが小数第1位を超える精度である時、THE System SHALL 小数第1位に丸める
3. WHEN ユーザーがMode 3（仮ポイント）で入力し、かつ計算された仮ポイントが-999.9から999.9の範囲外である時、THE System SHALL エラーを表示する
4. WHEN 選択されたルールに該当する順位と浮き人数の組み合わせのウマが定義されていない時、THE System SHALL エラーを表示する

### Requirement 7: トップの最終ポイント下限バリデーション

**User Story:** 1位の成績を入力するユーザーとして、最終ポイントがルール上の最小値を下回っていないことを確認したい。これにより、1位なのに異常に低いポイントになる入力ミスを検出できる。

#### Acceptance Criteria

1. WHEN 順位が1位であり、かつ固定ウマルールを使用し、かつ最終ポイントが（トップウマ+トップオカ）未満である時、THE System SHALL エラーを表示する
2. WHEN 順位が1位であり、かつ浮きウマルールを使用し、かつ浮き人数が1以上であり、かつ最終ポイントが（該当する浮き人数のトップウマ+トップオカ）未満である時、THE System SHALL エラーを表示する
3. WHEN 順位が1位であり、かつMode 2（順位+素点）で入力し、かつ計算された最終ポイントが（該当するウマ+トップオカ）未満である時、THE System SHALL エラーを表示する

### Requirement 8: ラスの最終ポイント上限バリデーション

**User Story:** 最下位の成績を入力するユーザーとして、最終ポイントがルール上の最大値を上回っていないことを確認したい。これにより、最下位なのに異常に高いポイントになる入力ミスを検出できる。

#### Acceptance Criteria

1. WHEN 順位が最下位であり、かつ固定ウマルールを使用し、かつ最終ポイントが（ラスウマ）を超える時、THE System SHALL エラーを表示する
2. WHEN 順位が最下位であり、かつ浮きウマルールを使用し、かつ浮き人数が（ゲームモード人数-1）未満であり、かつ最終ポイントが（該当する浮き人数のラスウマ）を超える時、THE System SHALL エラーを表示する
3. WHEN 順位が最下位であり、かつMode 2（順位+素点）で入力し、かつ計算された最終ポイントが（該当するウマ）を超える時、THE System SHALL エラーを表示する

### Requirement 9: バリデーションエラーメッセージの明確性

**User Story:** バリデーションエラーが発生したユーザーとして、何が問題で、どう修正すればよいかを明確に理解したい。これにより、エラーを素早く解決できる。

#### Acceptance Criteria

1. WHEN バリデーションエラーが発生する時、THE System SHALL エラーの原因を日本語で明確に説明する
2. WHEN バリデーションエラーが発生する時、THE System SHALL 修正方法のヒントを提供する
3. WHEN 複数のバリデーションエラーが発生する時、THE System SHALL 全てのエラーを表示する
4. WHEN バリデーションエラーが発生する時、THE System SHALL エラーが発生した項目を視覚的に強調表示する

### Requirement 10: フロントエンドとバックエンドの二重バリデーション

**User Story:** システム管理者として、フロントエンドのバリデーションをバイパスした不正なデータがバックエンドに送信されないことを保証したい。これにより、データの整合性を確保できる。

#### Acceptance Criteria

1. THE System SHALL フロントエンドで全てのバリデーションを実行する
2. THE System SHALL バックエンドで全てのバリデーションを再度実行する
3. WHEN バックエンドでバリデーションエラーが発生する時、THE System SHALL 適切なHTTPステータスコード（400 Bad Request）を返す
4. WHEN バックエンドでバリデーションエラーが発生する時、THE System SHALL エラー詳細をJSON形式で返す

### Requirement 11: バリデーションの網羅的テスト

**User Story:** 開発者として、全てのバリデーションルールが正しく動作することを自動テストで確認したい。これにより、リグレッションを防ぎ、品質を保証できる。

#### Acceptance Criteria

1. THE System SHALL 各バリデーションルールに対して正常系テストケースを持つ
2. THE System SHALL 各バリデーションルールに対して異常系テストケースを持つ
3. THE System SHALL 複合バリデーションに対して境界値テストケースを持つ
4. THE System SHALL バリデーションテストのカバレッジが90%以上である
5. THE System SHALL フロントエンドとバックエンドで同等のテストケースを持つ

### Requirement 12: 仮ポイント（Mode 3）のバリデーション

**User Story:** 仮ポイント入力（順位のみ入力）を使用するユーザーとして、システムが計算する仮ポイントがルール設定と矛盾していないことを確認したい。これにより、仮ポイント計算の正確性を保証できる。

**補足:** Mode 3（仮ポイント）では、ユーザーは順位のみを入力し、システムが仮の素点を想定してポイントを計算します。例えば4人麻雀の場合、1位=40000点、2位=30000点、3位=20000点、4位=10000点のような仮の素点を使用します。

#### Acceptance Criteria

1. WHEN 浮きウマルールを使用し、かつMode 3で入力する時、THE System SHALL 浮き人数が必須であることを検証する
2. WHEN Mode 3で仮ポイントを計算する時、THE System SHALL 選択されたルールのウマとオカを使用して計算する
3. WHEN Mode 3で仮ポイントを計算する時、THE System SHALL 計算結果が-999.9から999.9の範囲内であることを検証する
4. WHEN 浮きウマルールを使用し、かつMode 3で入力する時、THE System SHALL 入力された浮き人数に対応するウマが定義されていることを検証する

### Requirement 13: バリデーション実行順序の最適化

**User Story:** 開発者として、バリデーションが論理的な順序で実行され、早期にエラーを検出できるようにしたい。これにより、パフォーマンスとユーザー体験を向上できる。

#### Acceptance Criteria

1. THE System SHALL 基本形式チェック（型・桁数）を最初に実行する
2. THE System SHALL ルール整合性チェックを2番目に実行する
3. THE System SHALL 浮き人数の存在可能性チェックを3番目に実行する
4. THE System SHALL 自分の素点と浮き人数の整合性チェックを4番目に実行する
5. THE System SHALL 順位と素点の関係チェックを5番目に実行する
6. THE System SHALL 最終ポイント計算・形式チェックを6番目に実行する
7. THE System SHALL 入力方式別の追加チェックを最後に実行する
