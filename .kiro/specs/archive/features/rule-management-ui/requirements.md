# ルール管理UI機能 要件書

## 概要

ユーザーが麻雀ルールを管理するための画面を追加します。管理者はグローバルルールと個人ルールの両方を管理でき、一般ユーザーは個人ルールのみを管理できます。

## 用語集

- **System**: Janlogアプリケーション
- **User**: 一般ユーザー（role=user）
- **Admin**: 管理者ユーザー（role=admin）
- **Global_Rule**: 全ユーザーが利用可能な管理者作成のルール
- **Personal_Rule**: 個人が作成した自分専用のルール
- **Rule_Management_Screen**: ルール管理画面
- **Tab_Navigation**: 画面下部のタブナビゲーション

## 要件

### 要件 1: ルール管理画面へのアクセス

**ユーザーストーリー:** ユーザーとして、ルール管理画面にアクセスしたいので、自分のルールを管理できる

#### 受入基準

1. WHEN User がアプリを起動した時 THEN THE System SHALL 画面下部にタブナビゲーションを表示する
2. WHEN User がタブナビゲーションを確認した時 THEN THE System SHALL 統計、履歴、対局登録、ルールの4つのタブを表示する
3. WHEN User がルールタブをタップした時 THEN THE System SHALL ルール管理画面を表示する
4. WHEN Admin がルールタブをタップした時 THEN THE System SHALL グローバルルールセクションと個人ルールセクションの両方を表示する
5. WHEN User がルールタブをタップした時 THEN THE System SHALL 個人ルールセクションのみを表示する

### 要件 2: ルール一覧の表示

**ユーザーストーリー:** ユーザーとして、利用可能なルール一覧を確認したいので、どのルールが使えるか把握できる

#### 受入基準

1. WHEN User がルール管理画面にアクセスした時 THEN THE System SHALL グローバルルール一覧を取得してAPI経由で表示する
2. WHEN User がルール管理画面にアクセスした時 THEN THE System SHALL 個人ルール一覧を取得してAPI経由で表示する
3. WHEN Admin がルール管理画面にアクセスした時 THEN THE System SHALL グローバルルールセクションを編集可能な状態で表示する
4. WHEN User がルール管理画面にアクセスした時 THEN THE System SHALL グローバルルールセクションを読み取り専用で表示する
5. WHEN ルール一覧が空の時 THEN THE System SHALL 「ルールがありません」メッセージを表示する
6. WHEN 各ルールを表示する時 THEN THE System SHALL ルール名、ゲームモード、ウマ・オカ設定、チップ有無を表示する

### 要件 3: 個人ルールの作成

**ユーザーストーリー:** ユーザーとして、自分専用のルールを作成したいので、よく使うルール設定を保存できる

#### 受入基準

1. WHEN User が個人ルールセクションの新規作成ボタンをタップした時 THEN THE System SHALL ルール作成フォームを表示する
2. WHEN User がルール作成フォームを表示した時 THEN THE System SHALL ルール名、ゲームモード、開始点、基準点、ウマ、オカ、チップ有無、メモの入力欄を表示する
3. WHEN User がゲームモードを選択した時 THEN THE System SHALL 選択されたモードに応じた適切な入力欄を表示する
4. WHEN User が開始点と基準点を入力した時 THEN THE System SHALL 一般的なウマ配列を自動提案する
5. WHEN User がルール情報を保存ボタンをタップした時 THEN THE System SHALL 入力データを検証する
6. WHEN 入力データが有効な時 THEN THE System SHALL API経由で個人ルールをDynamoDBに保存する
7. WHEN 保存が成功した時 THEN THE System SHALL 成功メッセージを表示してルール一覧画面に戻る
8. WHEN 保存が失敗した時 THEN THE System SHALL エラーメッセージを表示する

### 要件 4: 個人ルールの編集

**ユーザーストーリー:** ユーザーとして、自分の個人ルールを編集したいので、設定を変更できる

#### 受入基準

1. WHEN User が個人ルール一覧から編集ボタンをタップした時 THEN THE System SHALL 選択されたルールの編集フォームを表示する
2. WHEN 編集フォームが表示された時 THEN THE System SHALL 既存のルール情報を入力欄に表示する
3. WHEN User がルール情報を変更して保存ボタンをタップした時 THEN THE System SHALL 入力データを検証する
4. WHEN 入力データが有効な時 THEN THE System SHALL API経由でルールをDynamoDBに更新する
5. WHEN 更新が成功した時 THEN THE System SHALL 成功メッセージを表示してルール一覧画面に戻る
6. WHEN User がグローバルルールの編集ボタンをタップした時 THEN THE System SHALL 「グローバルルールは編集できません」メッセージを表示する

### 要件 5: 個人ルールの削除

**ユーザーストーリー:** ユーザーとして、不要になった個人ルールを削除したいので、ルール一覧を整理できる

#### 受入基準

1. WHEN User が個人ルール一覧から削除ボタンをタップした時 THEN THE System SHALL 削除確認ダイアログを表示する
2. WHEN User が削除を確認した時 THEN THE System SHALL API経由でルールをDynamoDBから削除する
3. WHEN 削除が成功した時 THEN THE System SHALL 成功メッセージを表示してルール一覧を更新する
4. WHEN User がグローバルルールの削除ボタンをタップした時 THEN THE System SHALL 「グローバルルールは削除できません」メッセージを表示する

### 要件 6: グローバルルールの管理（管理者のみ）

**ユーザーストーリー:** 管理者として、全ユーザーが利用できるグローバルルールを管理したいので、標準的なルールを提供できる

#### 受入基準

1. WHEN Admin がグローバルルールセクションの新規作成ボタンをタップした時 THEN THE System SHALL ルール作成フォームを表示する
2. WHEN Admin がルール情報を保存ボタンをタップした時 THEN THE System SHALL isGlobalフラグをtrueに設定してAPI経由で保存する
3. WHEN Admin がグローバルルール一覧から編集ボタンをタップした時 THEN THE System SHALL 選択されたルールの編集フォームを表示する
4. WHEN Admin がグローバルルールを更新した時 THEN THE System SHALL API経由でルールをDynamoDBに更新する
5. WHEN Admin がグローバルルール一覧から削除ボタンをタップした時 THEN THE System SHALL 削除確認ダイアログを表示する
6. WHEN Admin が削除を確認した時 THEN THE System SHALL API経由でルールをDynamoDBから削除する

### 要件 7: 使用中ルールの変更制限

**ユーザーストーリー:** ユーザーとして、既に使用されたルールを後から変更できるようにしたいので、ルール設定を柔軟に管理できる

#### 受入基準

1. WHEN User がルールを編集する時 THEN THE System SHALL 使用履歴の有無に関わらず編集を許可する
2. WHEN User がルールを削除しようとした時 THEN THE System SHALL 使用履歴の有無に関わらず削除を許可する
3. WHEN ルールが変更された時 THEN THE System SHALL 既存の対局データには影響を与えない
4. WHEN ルールが削除された時 THEN THE System SHALL 既存の対局データのrulesetIdは保持する
5. WHEN 削除されたルールを参照する対局を表示する時 THEN THE System SHALL 「削除されたルール」と表示する

### 要件 8: ルール選択時の表示

**ユーザーストーリー:** ユーザーとして、対局登録時にルールを選択する際、グローバルルールと個人ルールを区別して表示したいので、適切なルールを選択できる

#### 受入基準

1. WHEN User が対局登録画面でルール選択フィールドをタップした時 THEN THE System SHALL グローバルルールと個人ルールを区別して表示する
2. WHEN ルール選択リストが表示された時 THEN THE System SHALL グローバルルールセクションを先に表示する
3. WHEN ルール選択リストが表示された時 THEN THE System SHALL 個人ルールセクションをグローバルルールの後に表示する
4. WHEN 各ルールを表示する時 THEN THE System SHALL ルール名とゲームモードを表示する
5. WHEN User がルールを選択した時 THEN THE System SHALL 選択されたルールのゲームモードに応じた入力欄を表示する

## 設計上の検討事項

### タブ配置の方針

**選択肢1: ルールを独立したタブとして追加**
- メリット: アクセスしやすい、機能が明確
- デメリット: 将来的にタブが増えすぎる可能性

**選択肢2: マスタ管理タブにまとめる**
- メリット: 将来の拡張に対応しやすい（会場マスタ、メンバーマスタ等）
- デメリット: 階層が深くなる、アクセスが1ステップ増える

**推奨: 選択肢1（ルールを独立したタブとして追加）**
- 理由: MVP段階ではルール管理が唯一のマスタ機能であり、独立タブの方がUXが良い
- 将来的にマスタが増えた場合は、その時点でタブ構成を見直す

### ルール変更の影響範囲

**設計方針: 既存対局データへの影響なし**
- ルール変更・削除は既存の対局データに影響を与えない
- 対局データはrulesetIdのみを保持し、ルール内容は保持しない
- ルールが削除された場合、対局詳細画面では「削除されたルール」と表示
- ユーザーは同じルール名で新しい設定を使いたい場合、既存ルールを編集できる

**理由:**
- 既存の対局は計算済みのfinalPointsを保持しているため、ルール変更の影響を受けない
- ユーザーは柔軟にルール設定を変更できる
- 過去の対局記録の整合性は保たれる（計算済みポイントは変わらない）

## 将来の拡張要件（参考）

- 会場マスタ管理画面の追加
- メンバーマスタ管理画面の追加（セット麻雀機能）
- ルールテンプレートの提供（Mリーグルール、フリー雀荘標準ルール等）
- ルールのインポート・エクスポート機能
