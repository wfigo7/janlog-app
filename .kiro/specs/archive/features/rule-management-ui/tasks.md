# ルール管理UI機能 実装タスク

## タスク一覧

- [x] 1. フロントエンド：ルール管理画面の基本構造を実装
  - タブナビゲーションに「ルール」タブを追加
  - RuleManagementScreenコンポーネントを作成
  - ユーザーロールに応じた表示制御を実装
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5_

- [x] 2. フロントエンド：ルール一覧表示機能を実装
  - RuleListコンポーネントを作成
  - RuleCardコンポーネントを作成
  - グローバルルールと個人ルールの区別表示を実装
  - 空状態の表示を実装
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 2.6_

- [x] 3. フロントエンド：ルール作成フォームを実装
  - RuleFormScreenコンポーネントを作成
  - 入力フォーム（ルール名、ゲームモード、開始点、基準点、ウマ、オカ、チップ、メモ）を実装
  - ウマ自動提案機能を実装
  - バリデーション機能を実装
  - API呼び出しと成功・エラー処理を実装
  - _要件: 3.1, 3.2, 3.3, 3.4, 3.5, 3.6, 3.7, 3.8_


- [x] 4. フロントエンド：ルール編集機能を実装
  - 編集モードでのRuleFormScreen表示を実装
  - 既存ルール情報の読み込みと表示を実装
  - 更新API呼び出しと成功・エラー処理を実装
  - グローバルルール編集時の権限チェックを実装
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

- [x] 5. フロントエンド：ルール削除機能を実装
  - RuleDeleteDialogコンポーネントを作成
  - 削除確認ダイアログを実装
  - 削除API呼び出しと成功・エラー処理を実装
  - グローバルルール削除時の権限チェックを実装
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 6. バックエンド：ルール管理APIの権限チェックを実装
  - POST /rulesetsにグローバルルール作成の権限チェックを追加
  - PUT /rulesets/{rulesetId}にグローバルルール更新の権限チェックを追加
  - DELETE /rulesets/{rulesetId}にグローバルルール削除の権限チェックを追加
  - 個人ルールの所有者チェックを追加
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [x] 7. フロントエンド：対局登録画面のルール選択UIを改善
  - ルール選択リストでグローバルルールと個人ルールを区別表示
  - セクション分けの実装
  - _要件: 8.1, 8.2, 8.3, 8.4, 8.5_

- [x] 8. テスト：フロントエンドのテストを作成
  - RuleCardコンポーネントのテスト
  - RuleManagementScreenのロール別表示テスト
  - RuleFormScreenのバリデーションテスト
  - _要件: 全体_

- [x] 9. テスト：バックエンドのテストを作成
  - グローバルルール作成の権限チェックテスト
  - グローバルルール更新の権限チェックテスト
  - グローバルルール削除の権限チェックテスト
  - 個人ルールの所有者チェックテスト
  - _要件: 6.1, 6.2, 6.3, 6.4, 6.5, 6.6_

- [x] 10. ドキュメント：Core統合とREADME更新
  - core/requirements.mdに要件を統合
  - core/design.mdに設計を統合
  - プロジェクトREADMEの機能一覧を更新
  - _要件: 全体_

## 実装の注意事項

### タスク1: タブナビゲーション追加
- `frontend/src/components/navigation/TabNavigation.tsx`を編集
- 既存の3つのタブ（統計、履歴、対局登録）に「ルール」タブを追加
- アイコンは`cog`（歯車）を使用
- ユーザーロールの取得は既存の認証コンテキストを使用

### タスク2: ルール一覧表示
- カード形式で見やすく表示
- ルール名、ゲームモード、ウマ・オカ設定を一目で確認可能に
- 編集・削除ボタンは権限に応じて表示制御

### タスク3: ルール作成フォーム
- ゲームモード選択時に適切な入力欄を表示
- 開始点・基準点入力時にウマを自動提案
  - 3人麻雀: [+20, 0, -20]
  - 4人麻雀（25000点持ち30000点返し）: [+30, +10, -10, -30]
  - 4人麻雀（その他）: [+20, +10, -10, -20]
- リアルタイムバリデーション（500msデバウンス）

### タスク4: ルール編集機能
- 作成フォームと同じコンポーネントを使用（mode='edit'）
- 既存データの読み込みと表示
- グローバルルールの編集は管理者のみ（フロントエンドで制御）

### タスク5: ルール削除機能
- 削除前に確認ダイアログを表示
- 「既存の対局データには影響しません」と明記
- グローバルルールの削除は管理者のみ（フロントエンドで制御）

### タスク6: バックエンド権限チェック
- フロントエンドの制御は回避可能なため、バックエンドで必ず権限チェック
- グローバルルールの操作は管理者のみ許可
- 個人ルールは作成者本人のみ編集・削除可能
- 権限エラーは403 Forbiddenで返す

### タスク7: 対局登録画面の改善
- ルール選択リストをセクション分け
  - グローバルルールセクション
  - 個人ルールセクション
- 既存の`MatchRegistrationScreen.tsx`を編集

### タスク8-9: テスト（オプション）
- コア機能の実装後に実施
- 単体テスト、統合テストを作成
- 権限チェックのテストは必須

### タスク10: ドキュメント統合（オプション）
- 機能完成後にCore仕様書に統合
- 新機能の説明をREADMEに追加

## 実装順序の推奨

1. **Phase 1: 基本機能（タスク1-5）**
   - ルール管理画面の基本構造
   - ルール一覧表示
   - ルール作成・編集・削除

2. **Phase 2: セキュリティ（タスク6）**
   - バックエンドの権限チェック実装

3. **Phase 3: UX改善（タスク7）**
   - 対局登録画面のルール選択UI改善

4. **Phase 4: テスト・ドキュメント（タスク8-10、オプション）**
   - テストコード作成
   - ドキュメント統合

## 完了条件

- [x] 管理者がグローバルルールを作成・編集・削除できる
- [x] 一般ユーザーが個人ルールを作成・編集・削除できる
- [x] 一般ユーザーがグローバルルールを編集・削除しようとするとエラーメッセージが表示される
- [x] ルール一覧でグローバルルールと個人ルールが区別して表示される
- [x] ルール作成時にウマが自動提案される
- [x] バックエンドで適切な権限チェックが行われる
- [x] 対局登録画面でルール選択時にグローバルルールと個人ルールが区別表示される
