# 浮きウマルール機能 実装タスク

## 実装方針

本タスクリストは、浮きウマルール機能を段階的に実装するための具体的なタスクを定義します。各タスクは独立して実装可能で、前のタスクの成果物を活用しながら進めます。

## タスク一覧

- [x] 1. データモデルとバリデーション基盤の実装
  - Rulesetエンティティに`useFloatingUma`と`umaMatrix`フィールドを追加
  - Matchエンティティに`floatingCount`フィールドを追加
  - TypeScript型定義を更新（FloatingUmaMatrix型の追加）
  - _要件: 1.9, 1.10_

- [x] 1.1 バックエンド: FloatingUmaValidator実装
  - `backend/app/utils/floating_uma_validator.py`を作成
  - `validate_uma_matrix()`メソッドを実装（要素数・合計値検証）
  - `validate_uma_array()`メソッドを実装
  - `get_valid_floating_counts()`メソッドを実装（有効範囲取得）
  - _要件: 1.7, 1.8, 2.8, 2.9, 2.10, 6.1, 6.2, 6.3, 6.4_

- [x] 1.2 バックエンド: FloatingUmaCalculator実装
  - `backend/app/utils/floating_uma_calculator.py`を作成
  - `calculate_points()`メソッドを実装（浮きウマポイント計算）
  - `get_uma_for_floating_count()`メソッドを実装（ウマ配列取得）
  - `is_player_floating()`メソッドを実装（浮き判定）
  - _要件: 3.1, 3.2, 3.3, 2.2, 2.3, 2.4_

- [x] 1.3 バックエンド: FloatingUmaValidator単体テスト
  - `tests/unit/test_floating_uma_validator.py`を作成
  - ウマ配列要素数検証のテスト
  - マ配列合計値検証のテスト
  - 有効な浮き人数範囲取得のテスト
  - _要件: 6.1, 6.2, 6.3, 6.4_

- [x] 1.4 バックエンド: FloatingUmaCalculator単体テスト
  - `tests/unit/test_floating_uma_calculator.py`を作成
  - 浮きウマポイント計算のテスト（各浮き人数パターン）
  - ウマ配列取得のテスト
  - 浮き判定のテスト
  - _要件: 3.1, 3.2, 3.3_

- [x] 2. ルールセットAPI拡張

  - RulesetモデルにuseFloatingUmaとumaMatrixフィールドを追加
  - POST /rulesetsエンドポイントを拡張（浮きウマ設定の保存）
  - PUT /rulesets/{rulesetId}エンドポイントを拡張
  - GET /rulesetsエンドポイントのレスポンスに浮きウマ情報を追加
  - FloatingUmaValidatorを使用したバリデーション実装
  - _要件: 1.1, 1.2, 1.3, 1.9, 1.10_

- [x] 2.1 バックエンド: ポイント計算API拡張
  - POST /rulesets/calculateエンドポイントを拡張
  - リクエストボディに`floatingCount`パラメータを追加
  - FloatingUmaCalculatorを使用した計算ロジック実装
  - レスポンスに浮き人数とウマ配列情報を追加
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [x] 2.2 バックエンド: 対局登録API拡張
  - MatchモデルにfloatingCountフィールドを追加
  - POST /matchesエンドポイントを拡張
  - リクエストボディに`floatingCount`パラメータを追加
  - 浮きウマルール使用時のfloatingCountバリデーション実装
  - _要件: 6.7, 6.8, 2.5, 2.6, 2.7_

- [x] 2.3 バックエンド: seeds/rulesets.yamlデータ追加
  - 既存データとAPI修正に矛盾がないかチェック
  - 日本プロ麻雀連盟の公式ルールを初期データとして追加
  - scripts/db/seed_rulesets.pyの修正（必要があれば）
  - scripts/db/seed_rulesets.pyの実行（ローカルのデータをクリアして再登録）
 
- [ ]* 2.4 バックエンド: ルールセットAPI統合テスト
  - `tests/integration/test_rulesets_floating_uma.py`を作成
  - 浮きウマルールの作成テスト
  - 浮きウマルールの更新テスト
  - バリデーションエラーのテスト
  - _要件: 1.1, 1.2, 1.3, 1.9, 1.10_

- [ ]* 2.5 バックエンド: ポイント計算API統合テスト
  - `tests/integration/test_calculate_floating_uma.py`を作成
  - 各浮き人数でのポイント計算テスト
  - エラーケースのテスト
  - _要件: 3.1, 3.2, 3.3, 3.4_

- [ ]* 2.6 バックエンド: 対局登録API統合テスト
  - `tests/integration/test_matches_floating_uma.py`を作成
  - 浮きウマルールでの対局登録テスト
  - 浮き人数バリデーションのテスト
  - _要件: 2.5, 2.6, 2.7, 6.7, 6.8_

- [x] 3. フロントエンド: 浮きウマ設定UI実装
  - FloatingUmaToggleコンポーネントを作成
  - FloatingUmaMatrixInputコンポーネントを作成
  - 開始点と基準点から使用する浮き人数を自動判定
  - 使用しない浮き人数の入力欄をグレーアウト
  - _要件: 1.1, 1.2, 1.3, 1.4, 1.5, 1.6, 8.1, 8.2, 8.3_

- [x] 3.1 フロントエンド: ルールセット作成・編集画面統合
  - RuleFormScreenに浮きウマ設定UIを統合
  - useRuleFormフックに浮きウマ状態管理を追加
  - フロントエンドバリデーション実装
  - エラーメッセージ表示
  - _要件: 1.7, 1.8, 6.1, 6.2, 6.3_

- [x] 3.2 フロントエンド: ルール詳細画面に浮きウマ表示
  - FloatingUmaDisplayコンポーネントを作成
  - ルール詳細画面に浮きウマ情報を表示
  - 浮き人数別ウマ表を表形式で表示
  - _要件: 4.1, 4.2, 4.3_

- [x] 4. フロントエンド: 対局登録画面の浮き人数入力UI実装
  - FloatingCountInputコンポーネントを作成
  - 浮き人数入力フィールドの実装
  - 有効範囲の動的設定（開始点と基準点から判定）
  - 自身の浮き判定結果表示（「自身は浮き」「自身は沈み」）
  - _要件: 2.1, 2.2, 2.3, 2.4, 8.4, 8.5_

- [x] 4.1 フロントエンド: 対局登録画面統合（順位+素点）
  - MatchRegistrationScreenに浮き人数入力UIを統合
  - 素点入力時に自身の浮き判定を自動実行
  - 浮き人数を手動入力
  - ポイント計算APIに浮き人数を送信
  - 計算結果に浮き人数とウマ配列を表示
  - _要件: 2.5, 3.5, 3.4_

- [x] 4.2 フロントエンド: 対局登録画面統合（順位のみ）
  - 仮ポイント入力方式で浮き人数入力UIを表示
  - 浮き人数を手動入力
  - ポイント計算APIに浮き人数を送信
  - 計算結果に浮き人数とウマ配列を表示
  - _要件: 2.6, 3.6_

- [x] 4.3 フロントエンド: 対局登録画面統合（順位+最終ポイント）
  - 最終ポイント入力方式では浮き人数入力欄を非表示
  - floatingCountをnullとして保存
  - _要件: 2.7_

- [x] 4.4 フロントエンド: 対局登録バリデーション実装
  - 浮きウマルール使用時の浮き人数必須チェック
  - 浮き人数範囲チェック
  - エラーメッセージ表示
  - _要件: 6.5, 6.6, 6.7, 6.8_

- [x] 5. 3人麻雀対応
  - FloatingUmaMatrixInputで3人麻雀の浮き人数範囲を設定
  - FloatingCountInputで3人麻雀の浮き人数範囲を設定
  - バックエンドバリデーションで3人麻雀の要素数チェック
  - ポイント計算で3人麻雀のウマ配列を使用
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5_

- [ ]* 5.1 E2Eテスト: ルールセット作成フロー
  - 浮きウマルールの作成
  - 浮き人数別ウマ表の入力
  - 保存と確認
  - _要件: 1.1, 1.2, 1.3, 1.9, 1.10_

- [ ]* 5.2 E2Eテスト: 対局登録フロー（順位+素点）
  - 浮きウマルールでの対局登録
  - 自身の浮き判定確認
  - 浮き人数入力
  - ポイント計算確認
  - 保存と確認
  - _要件: 2.1, 2.2, 2.3, 2.4, 2.5, 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ]* 5.3 E2Eテスト: 対局登録フロー（順位のみ）
  - 浮きウマルールでの対局登録
  - 浮き人数入力
  - 仮ポイント計算確認
  - 保存と確認
  - _要件: 2.1, 2.6, 3.1, 3.2, 3.3, 3.4, 3.6_

- [ ]* 5.4 E2Eテスト: 対局登録フロー（順位+最終ポイント）
  - 浮きウマルールでの対局登録
  - 浮き人数入力欄が非表示であることを確認
  - 保存と確認
  - _要件: 2.1, 2.7_

- [x] 6. データマイグレーション対応
  - 既存ルールセット読み込み時のデフォルト値設定
  - 既存対局データ表示時のnullチェック
  - 互換性テストの実装
  - _要件: 5.1, 5.2, 5.3, 5.4, 5.5, 5.6_

- [x] 7. ドキュメント更新
  - OpenAPI仕様書の更新（/spec/openapi.yaml）
  - Core要件書への統合（.kiro/specs/core/requirements.md）
  - Core設計書への統合（.kiro/specs/core/design.md）
  - README.mdの更新（機能説明の追加）

## 実装順序の推奨

1. **フェーズ1: バックエンド基盤**（タスク1, 1.1, 1.2, 1.3, 1.4）
   - データモデルとバリデーション・計算ロジックの実装
   - 単体テストで品質を確保

2. **フェーズ2: API拡張**（タスク2, 2.1, 2.2, 2.3, 2.4, 2.5）
   - ルールセット・ポイント計算・対局登録APIの拡張
   - 統合テストでAPI動作を確認

3. **フェーズ3: フロントエンドUI**（タスク3, 3.1, 3.2）
   - ルールセット作成・編集・詳細画面の実装
   - 浮きウマ設定UIの完成

4. **フェーズ4: 対局登録統合**（タスク4, 4.1, 4.2, 4.3, 4.4）
   - 対局登録画面への浮き人数入力UI統合
   - 3つの入力方式への対応

5. **フェーズ5: 3人麻雀対応とテスト**（タスク5, 5.1, 5.2, 5.3, 5.4）
   - 3人麻雀の浮きウマ対応
   - E2Eテストで全体フローを確認

6. **フェーズ6: 仕上げ**（タスク6, 7）
   - データマイグレーション対応
   - ドキュメント更新

## 注意事項

- オプショナルタスク（*マーク）はコア機能に必須ではありませんが、品質保証のため推奨します
- 各タスクは前のタスクの成果物を活用するため、順序を守って実装してください
- バックエンドとフロントエンドは並行して実装可能ですが、API仕様の確定後にフロントエンド実装を開始することを推奨します
