# 浮きウマルール機能 要件書

## イントロダクション

浮きウマルールは、麻雀の競技ルールにおいて、基準点（返し点）以上の素点を持つプレイヤー数（浮き人数）に応じて順位点（ウマ）を変動させるルールです。Mリーグや日本プロ麻雀連盟などの競技麻雀で採用されており、実装価値が高い機能です。

本機能は、既存のルールセット管理機能を拡張し、浮きウマルールの設定・計算・表示を可能にします。

## 用語集

- **System**: Janlogアプリケーション
- **User**: アプリを使用する一般ユーザー
- **Admin**: 管理者権限を持つユーザー
- **Ruleset**: ルールセット（ウマ・オカ設定を含む麻雀ルール）
- **FloatingUma**: 浮きウマ（浮き人数に応じて変動するウマ）
- **FloatingCount**: 浮き人数（基準点以上の素点を持つプレイヤー数）
- **BasePoints**: 基準点（返し点、浮き判定の基準となる点数）
- **StartingPoints**: 開始点（対局開始時の持ち点）
- **UmaMatrix**: 浮き人数別ウマ表（浮き人数ごとのウマ配列を格納）
- **Match**: 対局データ
- **EntryMethod**: 入力方式（rank_plus_points, rank_plus_raw, provisional_rank_only）

## 要件

### 要件 1: 浮きウマルールセット設定

**ユーザーストーリー:** ユーザーとして、ルールセット作成・編集時に浮きウマルールを設定したいので、競技麻雀ルールに準拠した成績記録ができる

#### 受入基準

1. WHEN ユーザーがルールセット作成画面にアクセスする THEN システムは浮きウマ使用フラグ（useFloatingUma）の入力欄を表示する
2. WHEN ユーザーが浮きウマ使用フラグをOFFにする THEN システムは標準ウマ配列の入力欄のみを表示する
3. WHEN ユーザーが浮きウマ使用フラグをONにする THEN システムは浮き人数別ウマ表（umaMatrix）の入力欄を表示する
4. WHEN 開始点と基準点が等しい THEN システムは浮き人数1〜4の入力欄を表示する
5. WHEN 開始点が基準点より小さい THEN システムは浮き人数0〜3の入力欄を表示する
6. WHEN 浮き人数別ウマ表が表示される THEN システムは使用されない浮き人数の入力欄を読み取り専用または非表示にする
7. WHEN ユーザーが浮き人数別ウマ配列を入力する THEN システムは各配列が4要素（4人麻雀）または3要素（3人麻雀）であることを検証する
8. WHEN ユーザーが浮き人数別ウマ配列を入力する THEN システムは各配列の合計が0であることを検証する
9. WHEN ユーザーがルールセットを保存する THEN システムはuseFloatingUmaフラグとumaMatrixをDynamoDBに保存する
10. WHEN 浮きウマ使用フラグがOFFの場合 THEN システムはumaMatrixをnullまたは空オブジェクトとして保存する

### 要件 2: 浮き人数の計算

**ユーザーストーリー:** ユーザーとして、対局登録時に浮き人数を入力したいので、浮きウマルールに基づいた正確なポイント計算ができる

#### 受入基準

1. WHEN ユーザーが浮きウマルールを選択する THEN システムは浮き人数入力欄を表示する
2. WHEN 入力方式が「順位+素点」の場合 THEN システムは素点から浮き判定を自動実行する
3. WHEN 素点が基準点以上の場合 THEN システムはそのプレイヤーを浮きとしてカウントする
4. WHEN 素点が基準点未満の場合 THEN システムはそのプレイヤーを沈みとしてカウントする
5. WHEN 自動浮き判定が完了する THEN システムは浮き人数を表示する
6. WHEN 入力方式が「順位+素点」か「順位のみ」の場合 THEN システムは浮き人数の手動入力を要求する
7. WHEN 入力方式が「順位+最終ポイント」の場合 THEN システムは浮き人数入力欄を非表示にする
8. WHEN ユーザーが浮き人数を手動入力する THEN システムは有効範囲（0〜3または1〜4）であることを検証する
9. WHEN 開始点と基準点が等しい場合 THEN システムは浮き人数の範囲を1〜4に制限する
10. WHEN 開始点が基準点より小さい場合 THEN システムは浮き人数の範囲を0〜3に制限する

### 要件 3: 浮きウマを使用したポイント計算

**ユーザーストーリー:** ユーザーとして、浮きウマルールに基づいたポイント計算を自動実行したいので、手動計算のミスを防ぎ正確な成績記録ができる

#### 受入基準

1. WHEN 浮きウマルールが選択されている THEN システムは浮き人数に対応するウマ配列をumaMatrixから取得する
2. WHEN 浮き人数が入力される THEN システムはumaMatrix[浮き人数]のウマ配列を使用してポイント計算を実行する
3. WHEN ポイント計算が実行される THEN システムは（素点 - 基準点）/ 1000 + ウマ[順位-1] + オカの計算式を使用する
4. WHEN 計算結果が表示される THEN システムは使用された浮き人数とウマ配列を明示する
5. WHEN 入力方式が「順位+素点」の場合 THEN システムは素点入力時に自動でポイント計算を実行する
6. WHEN 入力方式が「順位のみ」の場合 THEN システムは仮素点を使用してポイント計算を実行する
7. WHEN 計算エラーが発生する THEN システムは適切なエラーメッセージを表示する

### 要件 4: 浮きウマルールの表示

**ユーザーストーリー:** ユーザーとして、ルールセット詳細画面で浮きウマルールの情報を確認したいので、どのルールで計算されるかを把握できる

#### 受入基準

1. WHEN ユーザーがルールセット詳細を表示する THEN システムは浮きウマ使用フラグの状態を表示する
2. WHEN 浮きウマが有効な場合 THEN システムは浮き人数別ウマ表を表形式で表示する
3. WHEN 浮きウマが無効な場合 THEN システムは標準ウマ配列のみを表示する

### 要件 5: 既存データとの互換性

**ユーザーストーリー:** ユーザーとして、既存の対局データやルールセットが浮きウマ機能追加後も正常に動作してほしいので、過去のデータを失わずに新機能を利用できる

#### 受入基準

1. WHEN 既存のルールセットを読み込む THEN システムはuseFloatingUmaフィールドが存在しない場合にfalseとして扱う
2. WHEN 既存のルールセットを読み込む THEN システムはumaMatrixフィールドが存在しない場合にnullとして扱う
3. WHEN useFloatingUmaがfalseまたは未定義の場合 THEN システムは標準ウマ配列（uma）を使用してポイント計算を実行する
4. WHEN 既存の対局データを表示する THEN システムは浮き人数フィールドが存在しない場合に「記録なし」と表示する
5. WHEN 既存のルールセットを編集する THEN システムは浮きウマ設定を追加できる
6. WHEN 浮きウマルールを標準ルールに変更する THEN システムはumaMatrixをnullに設定しuseFloatingUmaをfalseに設定する

### 要件 6: バリデーションとエラーハンドリング

**ユーザーストーリー:** ユーザーとして、浮きウマルール設定時に適切なバリデーションとエラーメッセージを受け取りたいので、正しい設定を行える

#### 受入基準

1. WHEN ユーザーが浮き人数別ウマ配列を入力する THEN システムは各配列の要素数が正しいことを検証する
2. WHEN ウマ配列の要素数が不正な場合 THEN システムは「ウマ配列は3要素（3人麻雀）または4要素（4人麻雀）である必要があります」エラーを表示する
3. WHEN ユーザーが浮き人数別ウマ配列を入力する THEN システムは各配列の合計が0であることを検証する
4. WHEN ウマ配列の合計が0でない場合 THEN システムは「ウマ配列の合計は0である必要があります」エラーを表示する
5. WHEN ユーザーが浮き人数を入力する THEN システムは有効範囲内であることを検証する
6. WHEN 浮き人数が範囲外の場合 THEN システムは「浮き人数は0〜3（または1〜4）の範囲で入力してください」エラーを表示する
7. WHEN 浮きウマルールで対局登録する THEN システムは浮き人数が必須であることを検証する
8. WHEN 浮き人数が未入力の場合 THEN システムは「浮き人数を入力してください」エラーを表示する

### 要件 7: 3人麻雀対応

**ユーザーストーリー:** ユーザーとして、3人麻雀でも浮きウマルールを使用したいので、4人麻雀と同様に浮きウマ機能を利用できる

#### 受入基準

1. WHEN ゲームモードが3人麻雀の場合 THEN システムは浮き人数別ウマ配列を3要素で入力できる
2. WHEN 開始点と基準点が等しい場合 THEN システムは浮き人数1〜3の入力欄を表示する
3. WHEN 開始点が基準点より小さい場合 THEN システムは浮き人数0〜2の入力欄を表示する
4. WHEN 3人麻雀で浮きウマ計算を実行する THEN システムは3要素のウマ配列を使用する
5. WHEN 3人麻雀の浮き人数を入力する THEN システムは有効範囲（0〜2または1〜3）であることを検証する

### 要件 8: UI/UX設計

**ユーザーストーリー:** ユーザーとして、浮きウマルール設定時に直感的で分かりやすいUIを使用したいので、複雑な設定を簡単に行える

#### 受入基準

1. WHEN 浮きウマ使用フラグをONにする THEN システムはスムーズなアニメーションで浮き人数別ウマ表を表示する
2. WHEN 浮き人数別ウマ表が表示される THEN システムは各浮き人数のラベルを明確に表示する
3. WHEN 使用されない浮き人数の入力欄が存在する THEN システムはグレーアウトまたは非表示にする
4. WHEN 対局登録画面で浮きウマルールを選択する THEN システムは浮き人数入力欄を明確に表示する
5. WHEN 浮き人数が自動計算される THEN システムは「自動計算」バッジを表示する

## 将来の拡張要件（参考）

以下は、MVP完了後に検討される将来の拡張要件です。

- 浮きウマルールテンプレートの提供（Mリーグ、日本プロ麻雀連盟など）
- 浮き判定点のカスタマイズ（基準点と異なる浮き判定点の設定）
- 浮き人数の統計分析（浮き人数別の成績集計）
- 浮きウマルールの詳細説明・ヘルプ機能
