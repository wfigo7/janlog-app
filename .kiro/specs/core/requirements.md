# 統合要件書

## 概要

Janlogは、フリー雀荘やセット麻雀の成績を個人用に記録・集計するモバイルアプリです。3人麻雀・4人麻雀の対局記録、複数の入力方式への対応、統計分析機能を提供し、紙やスプレッドシートでの管理をアプリで一元化します。

このドキュメントは、プロジェクト全体の要件を統合管理する「正」の仕様書です。

## 要件

### 要件 1: 招待制認証とパスワード管理

**ユーザーストーリー:** ユーザーとして、招待メール経由でアカウントを作成してログインしたいので、限定されたユーザーのみが利用できる安全な環境で成績データを管理できる。また、初回ログイン時および任意のタイミングでパスワードを変更できるようにしたい

#### 受入基準

**招待とアカウント作成:**
1. WHEN 管理者がCognito管理画面でユーザーを作成する THEN システムはカスタムメールテンプレートで招待メールを送信する
2. THE 招待メール SHALL ユーザー名と一時パスワード（`{username}`, `{####}`）を含む
3. THE 招待メール SHALL アプリへのアクセス方法を明確に説明する
4. WHERE development環境 THE 招待メール SHALL 開発版アプリのアクセス方法を説明する
5. WHERE production環境 THE 招待メール SHALL App Store/Google Playのダウンロードリンクを含む

**初回ログインとパスワード設定:**
6. WHEN ユーザーが一時パスワードでログインを試みる THEN システムはNEW_PASSWORD_REQUIRED Challengeを検出する
7. WHEN NEW_PASSWORD_REQUIRED Challengeが検出される THEN システムはパスワード変更画面を表示する
8. THE パスワード変更画面 SHALL 新しいパスワードと確認パスワードの入力フィールドを提供する
9. THE パスワード変更画面 SHALL Cognitoのパスワードポリシー（8文字以上、大文字・小文字・数字を含む）を表示する
10. WHEN ユーザーが新しいパスワードを入力する THEN システムはパスワードポリシーに準拠しているか検証する
11. WHEN 新しいパスワードと確認パスワードが一致しない THEN システムは不一致エラーメッセージを表示する
12. WHEN パスワード変更が成功する THEN システムは自動的にログイン状態にして統計画面を表示する

**通常ログインとパスワード変更:**
13. WHEN ユーザーがログイン画面でメールアドレスとパスワードを入力した時 THEN システムはCognito認証を実行する
14. WHEN 認証が成功した時 THEN システムはJWTトークンを発行してユーザー情報を取得する
15. WHEN 認証が失敗した時 THEN システムは適切なエラーメッセージを表示する
16. THE システム SHALL ユーザープロフィール画面にパスワード変更オプションを提供する
17. WHEN ログイン済みユーザーがパスワード変更を選択する THEN システムはパスワード変更画面を表示する
18. THE パスワード変更画面 SHALL 現在のパスワード、新しいパスワード、確認パスワードの入力フィールドを提供する
19. WHEN 現在のパスワードが間違っている THEN システムは認証エラーメッセージを表示する
20. WHEN パスワード変更が成功する THEN システムはログイン状態を維持する

**環境別動作:**
21. WHERE local環境 THE システム SHALL 静的JWT認証を使用しパスワード変更フローをスキップする
22. WHERE development環境またはproduction環境 THE システム SHALL 実際のCognito認証フローを使用する

### 要件 2: 対局記録

**ユーザーストーリー:** ユーザーとして、自分の3人麻雀・4人麻雀の対局結果を記録したいので、後で成績を振り返ることができる

#### 受入基準

1. WHEN ユーザーが対局登録画面にアクセスした時 THEN システムは対局情報入力フォームを表示する
2. WHEN ユーザーがゲームモード（3人/4人）を選択した時 THEN システムは自分の座席情報入力欄を表示する
3. WHEN ユーザーが入力方式（順位+最終ポイント、順位+素点、仮ポイント）を選択した時 THEN システムは対応する入力項目を表示する
4. WHEN ユーザーが対局日時を選択した時 THEN システムは選択された日時を対局データに設定する
5. WHEN ユーザーが自分の順位・ポイント情報を入力した時 THEN システムは入力データを検証する
6. WHEN 入力データが有効な時 THEN システムは対局結果をDynamoDBに保存する
7. WHEN 対局結果が正常に保存された時 THEN システムは成功メッセージを表示する

### 要件 3: 対局履歴

**ユーザーストーリー:** ユーザーとして、過去の対局履歴を確認したいので、自分の成績推移を把握できる

#### 受入基準

1. WHEN ユーザーが履歴画面にアクセスした時 THEN システムはデフォルトで4人麻雀の対局履歴一覧を日付順で表示する
2. WHEN ユーザーが3人麻雀タブを選択した時 THEN システムは3人麻雀の対局履歴のみを表示する
3. WHEN ユーザーが4人麻雀タブを選択した時 THEN システムは4人麻雀の対局履歴のみを表示する
4. WHEN ユーザーが期間フィルター（from/to）を指定した時 THEN システムは選択中のモード（3人/4人）の指定期間内の対局のみを表示する
5. WHEN 履歴が存在しない時 THEN システムは「履歴がありません」メッセージを表示する

### 要件 4: 成績統計

**ユーザーストーリー:** ユーザーとして、アプリ起動時に成績統計をトップ画面で確認したいので、自分の実力や傾向をすぐに把握できる

#### 受入基準

1. WHEN ユーザーがアプリを起動した時 THEN システムは統計画面をトップ画面として表示する
2. WHEN 統計画面が表示された時 THEN システムはデフォルトで4人麻雀の成績サマリ（対局数、平均順位、トップ率、ラス率、累積ポイント、チップ合計）を表示する
3. WHEN ユーザーが3人麻雀タブを選択した時 THEN システムは3人麻雀の成績サマリを表示する
4. WHEN ユーザーが4人麻雀タブを選択した時 THEN システムは4人麻雀の成績サマリを表示する
5. WHEN チップありルールでの対局がある時 THEN システムは統計にチップ合計を含めて表示する
6. WHEN チップなしルールでの対局のみの時 THEN システムは統計からチップ合計を除外して表示する
7. WHEN ユーザーが期間フィルターを指定した時 THEN システムは選択中のモード（3人/4人）の指定期間統計を計算して表示する
8. WHEN 統計データが存在しない時 THEN システムは「データが不足しています」メッセージを表示する

### 要件 5: 対局編集・削除

**ユーザーストーリー:** ユーザーとして、対局結果を修正・削除したいので、入力ミスを訂正できる

#### 受入基準

1. WHEN ユーザーが対局履歴から編集を選択した時 THEN システムは編集可能な入力フォームを表示する
2. WHEN ユーザーが修正内容を保存した時 THEN システムは変更内容を検証してDynamoDBを更新する
3. WHEN ユーザーが対局結果の削除を選択した時 THEN システムは確認ダイアログを表示する
4. WHEN ユーザーが削除を確認した時 THEN システムは対局結果をDynamoDBから削除する

### 要件 6: 複数入力方式

**ユーザーストーリー:** ユーザーとして、複数の入力方式を使い分けたいので、状況に応じて最適な記録方法で自分の成績を入力できる

#### 受入基準

1. WHEN ユーザーが「順位+最終ポイント」方式を選択した時 THEN システムは自分の順位と最終ポイントの入力欄を表示する
2. WHEN ユーザーが「順位+素点」方式を選択した時 THEN システムは自分の順位と素点の入力欄を表示し、選択されたルールを使用してサーバー側で最終ポイントを計算する
3. WHEN ユーザーが「仮ポイント」方式を選択した時 THEN システムは自分の順位のみの入力欄を表示し、選択されたルールに基づいてポイントを計算する
4. WHEN 各方式で入力が完了した時 THEN システムは統一されたMatch形式でデータを保存する

### 要件 7: ルール管理

**ユーザーストーリー:** ユーザーとして、麻雀ルール（ウマ・オカ設定）を管理したいので、よく使うルール設定を保存して対局登録時に選択できる

#### 受入基準

1. WHEN ユーザーがルール管理画面にアクセスした時 THEN システムは個人ルール一覧を表示する
2. WHEN 管理者がルール管理画面にアクセスした時 THEN システムはグローバルルールセクションと個人ルールセクションの両方を表示する
3. WHEN ユーザーが個人ルール作成ボタンをタップした時 THEN システムはルール作成フォームを表示する
4. WHEN ユーザーがルール情報（ルール名、ゲームモード、開始点、基準点、ウマ、オカ、チップ有無、メモ）を入力して保存した時 THEN システムは個人ルールをDynamoDBに保存する
5. WHEN ユーザーが開始点と基準点を入力した時 THEN システムは一般的なウマ配列を自動提案する
6. WHEN 管理者がグローバルルール作成ボタンをタップした時 THEN システムはグローバルルール作成フォームを表示する
7. WHEN 管理者がグローバルルールを保存した時 THEN システムはisGlobalフラグをtrueに設定してDynamoDBに保存する
8. WHEN ユーザーが個人ルールの編集ボタンをタップした時 THEN システムはルール編集フォームを表示する
9. WHEN ユーザーがグローバルルールの編集ボタンをタップした時 THEN システムは「グローバルルールは編集できません」メッセージを表示する
10. WHEN 管理者がグローバルルールの編集ボタンをタップした時 THEN システムはルール編集フォームを表示する
11. WHEN ユーザーが個人ルールの削除ボタンをタップした時 THEN システムは削除確認ダイアログを表示する
12. WHEN ユーザーが削除を確認した時 THEN システムは個人ルールをDynamoDBから削除する
13. WHEN ユーザーがグローバルルールの削除ボタンをタップした時 THEN システムは「グローバルルールは削除できません」メッセージを表示する
14. WHEN 管理者がグローバルルールの削除ボタンをタップした時 THEN システムは削除確認ダイアログを表示する
15. WHEN ルールが削除された時 THEN システムは既存の対局データのrulesetIdを保持する
16. WHEN 削除されたルールを参照する対局を表示する時 THEN システムは「削除されたルール」と表示する

### 要件 8: 対局登録時のルール選択

**ユーザーストーリー:** ユーザーとして、対局登録時にルールを選択したいので、適切なポイント計算で成績を記録できる

#### 受入基準

1. WHEN ユーザーが対局登録画面にアクセスした時 THEN システムは利用可能なルール一覧を表示する
2. WHEN ユーザーがルール選択フィールドをタップした時 THEN システムは個人ルールとグローバルルールを区別して表示する
3. WHEN ルール選択リストが表示された時 THEN システムは個人ルールを先に表示し、その後にグローバルルールを表示する
4. WHEN グローバルルールが表示された時 THEN システムは「公式」バッジを表示する
5. WHEN ユーザーがルールを選択した時 THEN システムは選択されたルールのゲームモード（3人/4人）に応じた入力欄を表示する
6. WHEN 選択されたルールでチップが有効な時 THEN システムはチップ入力欄を表示する
7. WHEN 選択されたルールでチップが無効な時 THEN システムはチップ入力欄を非表示にする
8. WHEN ユーザーが「順位+素点」方式を選択した時 THEN システムは選択されたルールのウマ・オカを使用してポイントを計算する
9. WHEN ポイント計算が完了した時 THEN システムは計算結果を表示してユーザーに確認を求める
10. WHEN ユーザーが計算結果を承認した時 THEN システムは対局結果をDynamoDBに保存する
11. WHEN ルール作成画面から対局登録画面に戻った時 THEN システムはルール一覧を自動的に更新する

### 要件 9: 会場・メモ管理

**ユーザーストーリー:** ユーザーとして、会場情報やメモを記録したいので、対局の詳細情報を管理できる

#### 受入基準

1. WHEN ユーザーが対局登録時に会場選択フィールドをタップした時 THEN システムは既存会場一覧をプルダウン表示する
2. WHEN ユーザーが既存会場を選択した時 THEN システムは選択された会場を対局データに関連付けて使用回数を増加する
3. WHEN ユーザーが「新しい会場を入力」を選択した時 THEN システムはテキスト入力フィールドを表示する
4. WHEN ユーザーが新しい会場名を入力した時 THEN システムは重複チェックを行い、重複がない場合は新規会場マスタを作成する
5. WHEN ユーザーが既存と同じ会場名を入力した時 THEN システムは既存会場を使用して重複作成を防ぐ
6. WHEN ユーザーが対局登録時にメモを入力した時 THEN システムはメモ情報を対局データに保存する
7. WHEN ユーザーが対局詳細を確認した時 THEN システムは会場名とメモを表示する
8. WHEN 会場やメモが未入力の時 THEN システムはnull値として適切に処理する

### 要件 10: 対局日指定

**ユーザーストーリー:** ユーザーとして、対局登録時に実際の対局日を指定したいので、当日以外に入力する場合でも正確な対局記録を残すことができる

#### 受入基準

1. WHEN ユーザーが対局登録画面にアクセスした時 THEN システムは対局日選択フィールドをデフォルトで現在日付に設定して表示する
2. WHEN ユーザーが対局日選択フィールドをタップした時 THEN システムは日付選択ピッカーを表示する
3. WHEN ユーザーが日付選択ピッカーで日付を変更した時 THEN システムは選択された日付を対局日フィールドに反映する
4. WHEN ユーザーが未来の日付を選択した時 THEN システムは「未来の日付は選択できません」エラーメッセージを表示する
5. WHEN ユーザーが過去5年より前の日付を選択した時 THEN システムは「5年以上前の日付は選択できません」エラーメッセージを表示する
6. WHEN 対局日が必須項目として未入力の時 THEN システムは「対局日を選択してください」エラーメッセージを表示する
7. WHEN 対局データを保存する時 THEN システムは選択された対局日に時刻00:00:00を補完してISO 8601形式でDynamoDBに保存する

### 要件 11: グローバルゲームモード選択

**ユーザーストーリー:** ユーザーとして、アプリ全体で一貫したゲームモード選択状態を維持したい。タブを移動しても選択したゲームモードが保持されることで、スムーズに操作できる

#### 受入基準

1. WHEN ユーザーがゲームモードを選択する THEN システムは選択されたゲームモードをアプリ全体で共有する
2. WHEN ユーザーがタブ間を移動する THEN システムは選択されたゲームモードを保持する
3. WHEN ユーザーがアプリを再起動する THEN システムは前回選択されたゲームモードを復元する
4. THE システムはデフォルトのゲームモードとして4人麻雀を設定する
5. THE システムはヘッダー右側にゲームモード切り替えUIを表示する
6. THE システムは現在選択されているゲームモードを視覚的に強調表示する
7. WHEN ユーザーがゲームモード切り替えUIをタップする THEN システムはゲームモードを切り替える
8. THE システムは統計画面のヘッダーにゲームモード切り替えUIを表示する
9. THE システムは履歴画面のヘッダーにゲームモード切り替えUIを表示する
10. THE システムは登録画面のヘッダーにゲームモード切り替えUIを表示する
11. THE システムはルール管理画面のヘッダーにゲームモード切り替えUIを表示する
12. THE システムはプロフィール画面のヘッダーにゲームモード切り替えUIを表示しない
13. WHEN ユーザーがゲームモードを切り替える THEN システムは統計画面のデータを新しいゲームモードで再取得する
14. WHEN ユーザーがゲームモードを切り替える THEN システムは履歴画面のデータを新しいゲームモードで再取得する
15. WHEN ユーザーがゲームモードを切り替える THEN システムは登録画面のフォームを新しいゲームモードで初期化する
16. WHEN ユーザーがゲームモードを切り替える THEN システムはルール管理画面のルールセット一覧を新しいゲームモードでフィルタリングする

---

## 将来の拡張要件（参考）

以下は、MVP完了後に検討される将来の拡張要件です。

- 画像からポイント表を取り込み（Textract）
- セット麻雀の共有機能（ルーム/メンバー管理）
- 外部認証（Google/Apple）
- Web版（PWA）
- 会場管理機能の拡張
- 詳細な統計グラフ表示
- パスワードリセット機能
- 多要素認証（MFA）
