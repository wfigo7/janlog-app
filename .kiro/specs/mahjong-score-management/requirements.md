# 要件書

## 概要

フリー雀荘やセット麻雀の成績を個人用に記録・集計するモバイルアプリ（Janlog）。3人麻雀・4人麻雀の対局記録、複数の入力方式への対応、統計分析機能を提供し、紙やスプレッドシートでの管理をアプリで一元化する。

## 要件

### 要件 1

**ユーザーストーリー:** ユーザーとして、招待メール経由でアカウントを作成してログインしたいので、限定されたユーザーのみが利用できる安全な環境で成績データを管理できる

#### 受入基準

1. WHEN 管理者が招待メールを送信した時 THEN システムは招待リンク付きのメールを対象ユーザーに送信する
2. WHEN ユーザーが招待リンクをクリックした時 THEN システムはアカウント作成画面を表示する
3. WHEN ユーザーがパスワードを設定してアカウントを作成した時 THEN システムはCognitoにユーザーを登録する
4. WHEN ユーザーがログイン画面でメールアドレスとパスワードを入力した時 THEN システムはCognito認証を実行する
5. WHEN 認証が成功した時 THEN システムはJWTトークンを発行してユーザー情報を取得する
6. WHEN 認証が失敗した時 THEN システムは適切なエラーメッセージを表示する
7. WHEN 招待されていないユーザーがアクセスした時 THEN システムは「招待が必要です」メッセージを表示する

### 要件 2

**ユーザーストーリー:** ユーザーとして、自分の3人麻雀・4人麻雀の対局結果を記録したいので、後で成績を振り返ることができる

#### 受入基準

1. WHEN ユーザーが対局登録画面にアクセスした時 THEN システムは対局情報入力フォームを表示する
2. WHEN ユーザーがゲームモード（3人/4人）を選択した時 THEN システムは自分の座席情報入力欄を表示する
3. WHEN ユーザーが入力方式（順位+最終スコア、順位+素点、仮スコア）を選択した時 THEN システムは対応する入力項目を表示する
4. WHEN ユーザーが自分の順位・スコア情報を入力した時 THEN システムは入力データを検証する
5. WHEN 入力データが有効な時 THEN システムは対局結果をDynamoDBに保存する
6. WHEN 対局結果が正常に保存された時 THEN システムは成功メッセージを表示する

### 要件 3

**ユーザーストーリー:** ユーザーとして、過去の対局履歴を確認したいので、自分の成績推移を把握できる

#### 受入基準

1. WHEN ユーザーが履歴画面にアクセスした時 THEN システムはデフォルトで4人麻雀の対局履歴一覧を日付順で表示する
2. WHEN ユーザーが3人麻雀タブを選択した時 THEN システムは3人麻雀の対局履歴のみを表示する
3. WHEN ユーザーが4人麻雀タブを選択した時 THEN システムは4人麻雀の対局履歴のみを表示する
4. WHEN ユーザーが期間フィルター（from/to）を指定した時 THEN システムは選択中のモード（3人/4人）の指定期間内の対局のみを表示する
5. WHEN 履歴が存在しない時 THEN システムは「履歴がありません」メッセージを表示する

### 要件 4

**ユーザーストーリー:** ユーザーとして、アプリ起動時に成績統計をトップ画面で確認したいので、自分の実力や傾向をすぐに把握できる

#### 受入基準

1. WHEN ユーザーがアプリを起動した時 THEN システムは統計画面をトップ画面として表示する
2. WHEN 統計画面が表示された時 THEN システムはデフォルトで4人麻雀の成績サマリ（対局数、平均順位、トップ率、ラス率、累積ポイント、チップ合計）を表示する
3. WHEN ユーザーが3人麻雀タブを選択した時 THEN システムは3人麻雀の成績サマリを表示する
4. WHEN ユーザーが4人麻雀タブを選択した時 THEN システムは4人麻雀の成績サマリを表示する
5. WHEN チップありルールでの対局がある時 THEN システムは統計にチップ合計を含めて表示する
6. WHEN チップなしルールでの対局のみの時 THEN システムは統計からチップ合計を除外して表示する
7. WHEN ユーザーが期間フィルターを指定した時 THEN システムは選択中のモード（3人/4人）の指定期間統計を計算して表示する
8. WHEN 統計データが存在しない時 THEN システムは「データが不足しています」メッセージを表示する

### 要件 5

**ユーザーストーリー:** ユーザーとして、対局結果を修正・削除したいので、入力ミスを訂正できる

#### 受入基準

1. WHEN ユーザーが対局履歴から編集を選択した時 THEN システムは編集可能な入力フォームを表示する
2. WHEN ユーザーが修正内容を保存した時 THEN システムは変更内容を検証してDynamoDBを更新する
3. WHEN ユーザーが対局結果の削除を選択した時 THEN システムは確認ダイアログを表示する
4. WHEN ユーザーが削除を確認した時 THEN システムは対局結果をDynamoDBから削除する

### 要件 6

**ユーザーストーリー:** ユーザーとして、複数の入力方式を使い分けたいので、状況に応じて最適な記録方法で自分の成績を入力できる

#### 受入基準

1. WHEN ユーザーが「順位+最終スコア」方式を選択した時 THEN システムは自分の順位と最終ポイントの入力欄を表示する
2. WHEN ユーザーが「順位+素点」方式を選択した時 THEN システムは自分の順位と素点の入力欄を表示し、選択されたルールを使用してサーバー側で最終スコアを計算する
3. WHEN ユーザーが「仮スコア」方式を選択した時 THEN システムは自分の順位のみの入力欄を表示し、選択されたルールに基づいてスコアを計算する
4. WHEN 各方式で入力が完了した時 THEN システムは統一されたMatch形式でデータを保存する

### 要件 7

**ユーザーストーリー:** ユーザーとして、麻雀ルールを管理したいので、異なるルールでの対局に対応できる

#### 受入基準

1. WHEN ユーザーがルール管理画面にアクセスした時 THEN システムはグローバルルール一覧と個人ルール一覧、新規作成機能を表示する
2. WHEN ユーザーが新しいルールを作成する時 THEN システムはルール名、ゲームモード（3人/4人）、開始点、基準点、ウマ、オカ、チップ有無、メモの入力欄を表示する
3. WHEN ユーザーが開始点と基準点を入力した時 THEN システムは一般的なウマ配列を自動提案する
4. WHEN ユーザーがチップ有無を設定した時 THEN システムはルール設定にチップ使用フラグを保存する
5. WHEN ユーザーがルール情報を保存する時 THEN システムは入力データを検証してDynamoDBに個人ルールとして保存する
6. WHEN 管理者がグローバルルールを作成する時 THEN システムは全ユーザーが利用可能なルールとしてDynamoDBに保存する
7. WHEN ユーザーが自分の個人ルールを編集・削除する時 THEN システムは対応する操作を実行する
8. WHEN ユーザーがグローバルルールを編集・削除しようとした時 THEN システムは「グローバルルールは編集できません」メッセージを表示する

### 要件 8

**ユーザーストーリー:** ユーザーとして、対局登録時にルールを選択したいので、適切なポイント計算で成績を記録できる

#### 受入基準

1. WHEN ユーザーが対局登録画面にアクセスした時 THEN システムは利用可能なルール一覧を表示する
2. WHEN ユーザーがルールを選択した時 THEN システムは選択されたルールのゲームモード（3人/4人）に応じた入力欄を表示する
3. WHEN 選択されたルールでチップが有効な時 THEN システムはチップ入力欄を表示する
4. WHEN 選択されたルールでチップが無効な時 THEN システムはチップ入力欄を非表示にする
5. WHEN ユーザーが「順位+素点」方式を選択した時 THEN システムは選択されたルールのウマ・オカを使用してポイントを計算する
6. WHEN ポイント計算が完了した時 THEN システムは計算結果を表示してユーザーに確認を求める
7. WHEN ユーザーが計算結果を承認した時 THEN システムは対局結果をDynamoDBに保存する

### 要件 9

**ユーザーストーリー:** ユーザーとして、会場情報やメモを記録したいので、対局の詳細情報を管理できる

#### 受入基準

1. WHEN ユーザーが対局登録時に会場IDを入力した時 THEN システムは会場情報を対局データに関連付ける
2. WHEN ユーザーが対局登録時にメモを入力した時 THEN システムはメモ情報を対局データに保存する
3. WHEN ユーザーが対局詳細を確認した時 THEN システムは会場情報とメモを表示する
4. WHEN 会場IDやメモが未入力の時 THEN システムはnull値として適切に処理する