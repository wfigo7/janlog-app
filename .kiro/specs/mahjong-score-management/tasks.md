# 実装計画

## MVP段階的開発アプローチ

この実装計画は、最小機能から始めて段階的に機能を追加していくMVPアプローチを採用します。各フェーズで動作するアプリケーションを作成し、ユーザーフィードバックを得ながら次のフェーズに進みます。

## フェーズ1: 基本インフラとシンプルな対局記録

- [x] 1. プロジェクト基盤セットアップ
  - モノレポ構造の作成（frontend、backend、infraディレクトリ）
  - 基本的なpackage.jsonとGitHub Actions設定
  - _要件: 全体的な開発環境_

- [x] 2. バックエンド最小構成の実装
  - FastAPI + LWA の基本セットアップ
  - DynamoDBシングルテーブルの基本構造作成
  - ヘルスチェックエンドポイント（GET /health）の実装
  - _要件: 2.5, 2.6_

- [x] 2.1. ローカル開発環境のDB構築
  - Docker Compose設定ファイルの作成
  - DynamoDB Localコンテナの設定
  - ローカル開発用のテーブル作成スクリプト
  - バックエンドのローカルDB接続設定
  - _要件: 開発環境の整備_

- [x] 3. 認証なしの対局記録API実装
  - 対局データモデル（Match）の実装
  - POST /matches エンドポイント（認証なし、固定ユーザーID使用）
  - GET /matches エンドポイント（認証なし、固定ユーザーID使用）
  - 基本的なバリデーション実装
  - _要件: 2.1, 2.2, 2.5, 2.6_

- [x] 4. フロントエンド最小構成の実装
  - Expo React Nativeプロジェクトの初期化
  - 基本的なナビゲーション構造（タブナビゲーション）
  - 対局登録画面の基本実装（順位+最終スコアのみ）
  - 対局一覧画面の基本実装
  - _要件: 2.1, 2.2, 3.1_

- [x] 5. 統計画面の基本実装
  - 統計計算ロジックの実装（対局数、平均順位、トップ率、ラス率）
  - GET /stats/summary エンドポイントの実装
  - 統計画面をトップ画面として実装
  - _要件: 4.1, 4.2, 4.6_

- [x] 6. CDK初期化と簡易S3作成
  - AWS CDKプロジェクトの初期化とセットアップ
  - 基本的なCDKスタック構成の作成
  - 簡易S3バケットの作成
  - CDKデプロイの動作確認
  - _要件: インフラ基盤の初期化_

- [x] 7. Cognito認証の実装
  - Cognito User Poolの作成とAWS CDK設定
  - JWT Authorizerの設定
  - バックエンドでのJWT検証実装
  - _要件: 1.4, 1.5, 1.6_

- [x] 7.1. 環境分離の詳細設計
  - local/development/production環境の詳細仕様確定
  - ADR-0005とenv-matrix.mdの更新
  - CDK環境分離設定の実装
  - バックエンド・フロントエンドの環境設定整備
  - _要件: 環境分離戦略の確立_

- [x] 7.2. 簡易CIの実装
  - GitHub Actions CI/CDワークフローの修正
  - フロントエンド簡単テストの作成と実行
  - バックエンド既存テストの実行確認
  - インフラ既存テストの実行確認
  - プッシュ時のビルド成功確認
  - _要件: 開発効率とコード品質の確保_

## フェーズ2: ゲームモード分離とルール管理

- [x] 8. ゲームモード分離の実装
  - 3人麻雀・4人麻雀のタブ分離
  - 統計画面でのモード別表示
  - 履歴画面でのモード別表示
  - _要件: 3.2, 3.3, 4.3, 4.4_

- [x] 9. ルールセット管理の実装
  - 新しいRulesetデータモデルの実装（開始点、基準点、浮きウマフラグ、ウマ配列、オカ、チップ有無、メモ、グローバル/個人区分）
  - 拡張性を考慮したumaMatrix構造の追加（浮きウマルール対応準備）
  - ルールセットCRUD API実装（グローバル作成は管理者のみ、個人作成は全ユーザー）
  - 標準ポイント計算ロジックの実装（useFloatingUma=false用）
  - ポイント計算プレビューAPI実装（POST /rulesets/calculate）
  - デフォルトグローバルルールセットの作成（Mリーグルール、フリー雀荘ルールなど）
  - ウマ自動提案ロジックの実装（開始点・基準点からウマを算出）
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7, 7.8_

- [x] 10. ルール選択機能の実装
  - 対局登録時のルール選択UI
  - ルール選択に基づく入力フォーム調整
  - チップ有無に基づくチップ入力欄の表示/非表示制御
  - _要件: 8.1, 8.2, 8.3, 8.4_

## フェーズ3: 基本機能の実装

- [x] 11. 素点入力方式の実装
  - 順位+素点入力UI
  - ウマ・オカを使用したポイント計算ロジック
  - 計算結果確認UI
  - バックエンドバリデーション強化（MatchRequestモデル）
  - フロントエンドリアルタイムバリデーション
  - 自動ポイント計算機能（デバウンス付き）
  - エラー表示とスクロール機能
  - 通知システム実装
  - バックエンドバリデーションテスト（test_match_validation.py）
  - フロントエンドコンポーネントテスト（MatchRegistrationScreen.test.tsx）
  - バリデーション関数単体テスト（validation.test.ts）
  - _要件: 6.2, 8.3, 8.4, 8.5_

- [x] 12. 仮スコア入力方式の実装
  - 順位のみ入力UI
  - ルールに基づく仮スコア計算
  - _要件: 6.3_

- [x] 13. 入力方式選択機能
  - 入力方式選択UI
  - 方式に応じた動的フォーム表示
  - _要件: 6.1, 6.4_

- [x] 14. 履歴機能の実装
  - バックエンドAPI実装
  - 対局履歴一覧画面の改善
  - ゲームモード別フィルタリング
  - 日付順ソート機能
  - 対局詳細表示機能
  - 履歴データのページネーション
  - _要件: 3.1, 3.2, 3.3_

- [x] 15. 統計機能の再設計と実装
  - 統計画面のUI/UX改善
  - ゲームモード別統計表示
  - 期間フィルター機能
  - グラフ・チャート表示
  - 詳細統計指標の追加
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

## フェーズ4: 認証機能の実装

- [x] 16. フロントエンド認証実装
  - ログイン画面の実装
  - Cognitoとの認証連携
  - トークン管理（Secure Storage）
  - API呼び出し時の認証ヘッダー設定（Authorization: Bearer {token}）
  - ローカル開発環境でのCognito連携テスト（devモード + API Gateway接続）
  - 開発環境デプロイ後の動作確認（実機テスト）
  - エラーハンドリング（認証失敗、トークン期限切れ等）
  - _要件: 1.4, 1.5, 1.6_

- [x] 16.1 バックエンド認証実装
  - 認証トークンの検証
  - 非認証APIと認証APIの切替
  - ロギング強化（DBアクセスログ出力(debug)、ユーザ情報出力（sub）
  - _要件: 1.4, 1.5, 1.6_

## フェーズ5: データ管理と拡張機能

- [x] 17. チップ管理のルールセット移行
  - OpenAPI仕様書の更新（RulesetスキーマにuseChipsフィールド追加、StatsSummaryのchipTotalをnullable化）
  - RulesetモデルにuseChipsフィールドを追加
  - ルール作成・編集画面にチップ有無の設定項目を追加
  - 対局登録画面でルール選択時のチップ入力欄表示制御を実装
  - 統計画面でチップありルールの対局がある場合のみチップ合計を表示
  - 既存ルールデータのマイグレーション（デフォルトでuseChips=false）
  - _要件: 7.4, 8.3, 8.4, 4.5, 4.6_

- [x] 18. 対局日選択機能の実装
  - 対局日選択コンポーネント（MatchDatePicker）の実装
  - 日付選択ピッカーUI（日付のみ）
  - デフォルト値設定（現在日付）
  - 日付バリデーション（未来日付・5年以上前の制限）
  - 対局登録画面への統合
  - バックエンドAPIの日付バリデーション強化
  - 日付形式の統一（ISO 8601、時刻00:00:00自動補完）
  - _要件: 10.1, 10.2, 10.3, 10.4, 10.5, 10.6, 10.7_

- [x] 19. 対局データ編集・削除機能
  - 対局編集画面の実装
  - PUT /matches/{matchId} エンドポイント
  - DELETE /matches/{matchId} エンドポイント
  - 削除確認ダイアログ
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [x] 20. 会場機能の実装
  - 会場データモデル（Venue）の実装（venueId、venueName、usageCount、lastUsedAt）
  - 会場マスタ管理サービスの実装（find_or_create_venue、重複チェック機能）
  - GET /venues エンドポイントの実装（ユーザーの会場一覧取得、使用回数順ソート）
  - 対局登録画面の会場選択コンポーネント実装（コンボボックス形式UI）
  - 会場選択時の動的UI制御（既存会場プルダウン表示、新規入力フィールド表示）
  - 対局登録時の会場自動マスタ化処理（重複チェック、使用回数更新）
  - 対局詳細表示での会場名表示機能
  - _要件: 9.1, 9.2, 9.3, 9.4, 9.5, 9.6, 9.7, 9.8_

- [x] 21. フィルター機能
  - 日付範囲選択UI
  - 統計・履歴での期間フィルタリング
  - ルールフィルタリング
  - 会場フィルタリング（会場一覧取得、プルダウン選択UI）
  - _要件: 3.4, 4.5_

- [ ] 22. ルール管理機能（フロントエンド）
  - ユーザロールの判別（adminロールのみ利用可能）
  - ルール一覧画面の実装
  - ルール作成画面の実装（チップ有無の設定項目を含む）
  - ルール編集画面の実装（チップ有無の設定項目を含む）
  - ルール削除機能の実装
  - ルールテンプレート選択機能
  - _要件: 7.1, 7.2, 7.3, 7.4, 8.1, 8.2, 8.3, 8.4_

## フェーズ6: 開発環境構築とデプロイメント

- [x] 23. DynamoDBスタックの実装
  - CDKでDynamoDBテーブル作成（シングルテーブル設計）
  - GSI（GSI1: MATCH_BY_USER_DATE、GSI2: MATCH_BY_USER_MODE_DATE）の設定
  - 環境別テーブル名設定（janlog-table-{environment}）
  - オンデマンド課金設定
  - 削除保護設定（production環境のみ）
  - _要件: データストレージの構築_

- [x] 24. Lambdaスタックの実装
  - CDKでLambda関数作成（FastAPI + LWA構成）
  - バックエンドコードのLambdaデプロイ設定
  - 環境変数設定（DynamoDB_TABLE_NAME、ENVIRONMENT等）
  - Lambda実行ロール設定（DynamoDB読み書き権限）
  - Lambda関数のタイムアウト・メモリ設定
  - _要件: バックエンドAPIの実行環境構築_

- [x] 25. Lambda Web Adapterを使用したコンテナベースデプロイメントへの移行
  - backend/Dockerfileの作成（AWS Lambda Python基本イメージ + LWA）
  - CDKのPythonFunctionからコンテナイメージベースのLambda関数に変更
  - ECRリポジトリの作成とCDK設定
  - backend/Makefileにdocker-build、docker-push、lambda-updateタスクを追加
  - ローカルでのDocker build & ECR pushテスト
  - Lambda関数のコンテナイメージ更新テスト
  - LWAによるFastAPI起動の動作確認
  - _要件: 現在のPythonFunction + bundling方式の問題解決_

- [x] 26. API Gateway統合の実装
  - API GatewayとLambda関数の統合設定
  - プロキシ統合設定（/{proxy+}ルート）
  - JWT Authorizerの有効化（認証付きエンドポイント用）
  - CORS設定の確認
  - API Gatewayデプロイメント設定
  - _要件: APIエンドポイントの公開_

- [x] 27. 開発環境疎通確認
  - DynamoDB→Lambda→API Gatewayの疎通確認
  - ヘルスチェックエンドポイント（/health）の動作確認
  - 対局登録・取得APIの動作確認
  - 統計APIの動作確認
  - エラーハンドリングの動作確認
  - _要件: バックエンドシステムの動作保証_

- [x] 28. フロントエンド環境設定
  - Expo開発環境設定ファイルの更新
  - API Gateway URLの設定
  - 認証設定（Cognito User Pool情報）
  - 環境別設定の分離（local/development）
  - _要件: フロントエンドの環境設定_

- [x] 29. Expo→API Gateway疎通確認
  - フロントエンドからAPI Gatewayへの接続確認
  - 対局登録・取得機能の動作確認
  - 統計表示機能の動作確認
  - エラーハンドリングの動作確認
  - ネットワークエラー時の挙動確認
  - _要件: フロントエンド・バックエンド連携の動作保証_

- [x] 30. Expoアプリの共有設定
  - Expo Development Buildの設定
  - EAS Buildの設定（開発用）
  - 内部配布用の設定
  - テスト用アプリの配布準備
  - _要件: アプリの配布・テスト環境構築_

- [x] 31. S3バケットの最適化と再作成
  - 既存バケット（janlog-test-bucket-development-713209208161）の削除
  - 命名規則に従った新バケット作成（janlog-frontend-development）
  - 静的Webサイトホスティング設定
  - パブリックアクセスブロック設定（CloudFront経由のみアクセス可能）
  - バケットポリシー設定（OAC用）
  - 環境別バケット作成対応（development/production）
  - CDKスタックの更新
  - _要件: Web版アプリ配信用ストレージの最適化_

- [x] 32. CloudFront配信設定の実装
  - CDKでCloudFrontディストリビューション作成
  - S3バケット（janlog-frontend-{environment}）をオリジンとして設定
  - OAC（Origin Access Control）設定によるS3アクセス制限
  - デフォルトルートオブジェクト設定（index.html）
  - SPA対応のエラーページ設定（404→index.html）
  - キャッシュポリシー設定（静的アセット最適化）
  - HTTPS強制設定
  - 環境別ディストリビューション作成（development/production）
  - _要件: Web版アプリの配信基盤構築_

- [x] 33. Expo Web版ビルドとデプロイ
  - Expo Web設定の追加（app.json/app.config.js）
  - Web版ビルドコマンドの実装（npx expo export:web）
  - ビルド出力ディレクトリの確認（dist/）
  - S3デプロイスクリプトの作成（AWS CLI使用）
  - Makefileにweb-build、web-deployタスクを追加
  - ローカルでのWeb版ビルドテスト
  - S3へのデプロイテスト
  - CloudFront経由でのアクセス確認
  - 認証フロー動作確認（Cognito連携）
  - API Gateway連携動作確認
  - _要件: Web版アプリのビルドとデプロイ自動化_

## フェーズ7: 最適化とテスト

- [x] 34. テスト実装
  - バックエンド単体テスト（pytest）
  - フロントエンド単体テスト（Jest）
  - インフラ単体テスト（Jest）
  - _テスト戦略に基づく_

- [x] 35. パフォーマンス最適化
  - DynamoDB GSI最適化
  - フロントエンドキャッシュ実装
  - Lambda最適化
  - Lambda Layer実装（依存関係最適化）
  - _パフォーマンス最適化に基づく_

- [ ] 36. デプロイメント自動化
  - AWS CDKによるインフラ自動化
  - GitHub Actionsによる CI/CD
  - 本番環境デプロイ
  - _CI/CD戦略に基づく_

- [x] 37. 監視・セキュリティ強化
  - CloudWatch監視・ログ設定
  - セキュリティ設定の強化
  - カスタムドメイン設定（将来）
  - _運用・セキュリティ強化に基づく_

## 各フェーズの完了基準

- **フェーズ1**: ローカル開発環境で認証なしの対局記録・一覧表示・基本統計が動作し、AWS CDKによる開発環境インフラが構築される
- **フェーズ2**: 3人麻雀・4人麻雀が分離され、ルール管理ができる
- **フェーズ3**: 3つの入力方式、履歴機能、統計機能がすべて実装される
- **フェーズ4**: 認証機能が実装される
- **フェーズ5**: データ編集・削除、会場・メモ管理ができる
- **フェーズ6**: 開発環境でバックエンドAPIが稼働し、フロントエンドから利用可能になる
- **フェーズ7**: 開発環境で安定稼働する

## 注意事項

- 各フェーズ完了時に動作確認を行い、問題があれば次のフェーズに進まない
- ユーザーフィードバックを各フェーズで収集し、必要に応じて計画を調整する
- 最小限の機能で各フェーズを完了させ、過度な実装は避ける