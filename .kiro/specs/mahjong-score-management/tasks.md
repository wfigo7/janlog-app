# 実装計画

## MVP段階的開発アプローチ

この実装計画は、最小機能から始めて段階的に機能を追加していくMVPアプローチを採用します。各フェーズで動作するアプリケーションを作成し、ユーザーフィードバックを得ながら次のフェーズに進みます。

## フェーズ1: 基本インフラとシンプルな対局記録

- [x] 1. プロジェクト基盤セットアップ
  - モノレポ構造の作成（frontend、backend、infraディレクトリ）
  - 基本的なpackage.jsonとGitHub Actions設定
  - _要件: 全体的な開発環境_

- [x] 2. バックエンド最小構成の実装
  - FastAPI + LWA の基本セットアップ
  - DynamoDBシングルテーブルの基本構造作成
  - ヘルスチェックエンドポイント（GET /health）の実装
  - _要件: 2.5, 2.6_

- [x] 2.1. ローカル開発環境のDB構築
  - Docker Compose設定ファイルの作成
  - DynamoDB Localコンテナの設定
  - ローカル開発用のテーブル作成スクリプト
  - バックエンドのローカルDB接続設定
  - _要件: 開発環境の整備_

- [x] 3. 認証なしの対局記録API実装
  - 対局データモデル（Match）の実装
  - POST /matches エンドポイント（認証なし、固定ユーザーID使用）
  - GET /matches エンドポイント（認証なし、固定ユーザーID使用）
  - 基本的なバリデーション実装
  - _要件: 2.1, 2.2, 2.5, 2.6_

- [x] 4. フロントエンド最小構成の実装
  - Expo React Nativeプロジェクトの初期化
  - 基本的なナビゲーション構造（タブナビゲーション）
  - 対局登録画面の基本実装（順位+最終スコアのみ）
  - 対局一覧画面の基本実装
  - _要件: 2.1, 2.2, 3.1_

- [x] 5. 統計画面の基本実装
  - 統計計算ロジックの実装（対局数、平均順位、トップ率、ラス率）
  - GET /stats/summary エンドポイントの実装
  - 統計画面をトップ画面として実装
  - _要件: 4.1, 4.2, 4.6_

- [x] 6. CDK初期化と簡易S3作成
  - AWS CDKプロジェクトの初期化とセットアップ
  - 基本的なCDKスタック構成の作成
  - 簡易S3バケットの作成
  - CDKデプロイの動作確認
  - _要件: インフラ基盤の初期化_

- [x] 7. Cognito認証の実装
  - Cognito User Poolの作成とAWS CDK設定
  - JWT Authorizerの設定
  - バックエンドでのJWT検証実装
  - _要件: 1.4, 1.5, 1.6_

- [x] 7.1. 環境分離の詳細設計
  - local/development/production環境の詳細仕様確定
  - ADR-0005とenv-matrix.mdの更新
  - CDK環境分離設定の実装
  - バックエンド・フロントエンドの環境設定整備
  - _要件: 環境分離戦略の確立_

- [x] 7.2. 簡易CIの実装
  - GitHub Actions CI/CDワークフローの修正
  - フロントエンド簡単テストの作成と実行
  - バックエンド既存テストの実行確認
  - インフラ既存テストの実行確認
  - プッシュ時のビルド成功確認
  - _要件: 開発効率とコード品質の確保_

## フェーズ2: ゲームモード分離とルール管理

- [x] 8. ゲームモード分離の実装
  - 3人麻雀・4人麻雀のタブ分離
  - 統計画面でのモード別表示
  - 履歴画面でのモード別表示
  - _要件: 3.2, 3.3, 4.3, 4.4_

- [x] 9. ルールセット管理の実装
  - 新しいRulesetデータモデルの実装（開始点、基準点、浮きウマフラグ、ウマ配列、オカ、メモ、グローバル/個人区分）
  - 拡張性を考慮したumaMatrix構造の追加（浮きウマルール対応準備）
  - ルールセットCRUD API実装（グローバル作成は管理者のみ、個人作成は全ユーザー）
  - 標準ポイント計算ロジックの実装（useFloatingUma=false用）
  - ポイント計算プレビューAPI実装（POST /rulesets/calculate）
  - デフォルトグローバルルールセットの作成（Mリーグルール、フリー雀荘ルールなど）
  - ウマ自動提案ロジックの実装（開始点・基準点からウマを算出）
  - _要件: 7.1, 7.2, 7.3, 7.4, 7.5, 7.6, 7.7_

- [x] 10. ルール選択機能の実装
  - 対局登録時のルール選択UI
  - ルール選択に基づく入力フォーム調整
  - _要件: 8.1, 8.2_

## フェーズ3: 基本機能の実装

- [x] 11. 素点入力方式の実装
  - 順位+素点入力UI
  - ウマ・オカを使用したポイント計算ロジック
  - 計算結果確認UI
  - バックエンドバリデーション強化（MatchRequestモデル）
  - フロントエンドリアルタイムバリデーション
  - 自動ポイント計算機能（デバウンス付き）
  - エラー表示とスクロール機能
  - 通知システム実装
  - バックエンドバリデーションテスト（test_match_validation.py）
  - フロントエンドコンポーネントテスト（MatchRegistrationScreen.test.tsx）
  - バリデーション関数単体テスト（validation.test.ts）
  - _要件: 6.2, 8.3, 8.4, 8.5_

- [x] 12. 仮スコア入力方式の実装
  - 順位のみ入力UI
  - ルールに基づく仮スコア計算
  - _要件: 6.3_

- [x] 13. 入力方式選択機能
  - 入力方式選択UI
  - 方式に応じた動的フォーム表示
  - _要件: 6.1, 6.4_

- [ ] 14. 履歴機能の実装
  - 対局履歴一覧画面の改善
  - ゲームモード別フィルタリング
  - 日付順ソート機能
  - 対局詳細表示機能
  - 履歴データのページネーション
  - _要件: 3.1, 3.2, 3.3_

- [ ] 15. 統計機能の再設計と実装
  - 統計画面のUI/UX改善
  - ゲームモード別統計表示
  - 期間フィルター機能
  - グラフ・チャート表示
  - 詳細統計指標の追加
  - _要件: 4.1, 4.2, 4.3, 4.4, 4.5, 4.6_

## フェーズ4: 認証機能の実装

- [ ] 16. フロントエンド認証実装
  - ログイン画面の実装
  - Cognitoとの認証連携
  - トークン管理（Secure Storage）
  - _要件: 1.4, 1.5, 1.6_

## フェーズ5: データ管理と拡張機能

- [ ] 17. 対局データ編集・削除機能
  - 対局編集画面の実装
  - PUT /matches/{matchId} エンドポイント
  - DELETE /matches/{matchId} エンドポイント
  - 削除確認ダイアログ
  - _要件: 5.1, 5.2, 5.3, 5.4_

- [ ] 18. 会場・メモ機能の実装
  - 会場ID入力フィールド
  - メモ入力フィールド
  - 対局詳細表示での会場・メモ表示
  - _要件: 9.1, 9.2, 9.3, 9.4_

- [ ] 19. 期間フィルター機能
  - 日付範囲選択UI
  - 統計・履歴での期間フィルタリング
  - _要件: 3.4, 4.5_

## フェーズ6: 最適化とテスト

- [ ] 20. テスト実装
  - バックエンド単体テスト（pytest）
  - フロントエンド単体テスト（Jest）
  - 基本的な統合テスト
  - _テスト戦略に基づく_

- [ ] 21. パフォーマンス最適化
  - DynamoDB GSI最適化
  - フロントエンドキャッシュ実装
  - Lambda最適化
  - _パフォーマンス最適化に基づく_

- [ ] 22. デプロイメント自動化
  - AWS CDKによるインフラ自動化
  - GitHub Actionsによる CI/CD
  - 本番環境デプロイ
  - _CI/CD戦略に基づく_

## 各フェーズの完了基準

- **フェーズ1**: ローカル開発環境で認証なしの対局記録・一覧表示・基本統計が動作し、AWS CDKによる開発環境インフラが構築される
- **フェーズ2**: 3人麻雀・4人麻雀が分離され、ルール管理ができる
- **フェーズ3**: 3つの入力方式、履歴機能、統計機能がすべて実装される
- **フェーズ4**: 認証機能が実装される
- **フェーズ5**: データ編集・削除、会場・メモ管理ができる
- **フェーズ6**: 本番環境で安定稼働する

## 注意事項

- 各フェーズ完了時に動作確認を行い、問題があれば次のフェーズに進まない
- ユーザーフィードバックを各フェーズで収集し、必要に応じて計画を調整する
- 最小限の機能で各フェーズを完了させ、過度な実装は避ける