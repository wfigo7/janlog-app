name: CD Pipeline

on:
  workflow_dispatch:
    inputs:
      deploy_backend:
        description: "Deploy Backend (Docker -> ECR -> Lambda)"
        required: false
        default: false
        type: boolean

      deploy_infrastructure:
        description: "Deploy Infrastructure (AWS CDK)"
        required: false
        default: false
        type: boolean

      deploy_frontend_web:
        description: "Deploy Frontend Web (Expo Web -> S3)"
        required: false
        default: false
        type: boolean

      build_frontend_mobile:
        description: "Build Frontend Mobile (EAS Build)"
        required: false
        default: false
        type: boolean

      environment:
        description: "Deployment Environment"
        required: true
        default: "development"
        type: choice
        options:
          - development
          # - production  # Phase 2„ÅßËøΩÂä†

env:
  AWS_REGION: ap-northeast-1
  ENVIRONMENT: ${{ inputs.environment }}
  AWS_ROLE_ARN: arn:aws:iam::713209208161:role/janlog-github-actions-${{ inputs.environment }}

jobs:
  # Backend Deployment Job (OIDC)
  deploy-backend:
    name: Deploy Backend
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy_backend }}
    # OIDCË™çË®º„Å´ÂøÖË¶Å„Å™Ê®©Èôê
    permissions:
      id-token: write
      contents: read
    env:
      ECR_URI: 713209208161.dkr.ecr.ap-northeast-1.amazonaws.com/janlog-api-development
      LAMBDA_FUNCTION_NAME: janlog-api-development

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Backend-${{ github.run_id }}

      - name: Verify AWS connection
        run: |
          echo "Testing AWS connection..."
          aws sts get-caller-identity
          echo "‚úÖ AWS authentication successful (OIDC)"

      - name: Login to AWS Public ECR
        run: |
          echo "Logging in to AWS Public ECR to avoid rate limits..."
          aws ecr-public get-login-password --region us-east-1 | docker login --username AWS --password-stdin public.ecr.aws
          echo "‚úÖ AWS Public ECR login successful"

      - name: Deploy Backend
        run: |
          echo "üöÄ Deploying Backend (Docker -> ECR -> Lambda)..."
          make deploy-backend
          echo "‚úÖ Backend deployment completed"

      - name: Deployment Summary
        run: |
          echo "üìä Deployment Summary"
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "Component: Backend (Docker -> ECR -> Lambda)"
          echo "ECR URI: ${{ env.ECR_URI }}:latest"
          echo "Lambda Function: ${{ env.LAMBDA_FUNCTION_NAME }}"
          echo "Status: ‚úÖ Success"
          echo "Authentication: OIDC"

  # Infrastructure Deployment Job (OIDC)
  deploy-infrastructure:
    name: Deploy Infrastructure
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy_infrastructure }}
    # OIDCË™çË®º„Å´ÂøÖË¶Å„Å™Ê®©Èôê
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./infra

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: infra/.nvmrc
          cache: "npm"
          cache-dependency-path: infra/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-Infrastructure-${{ github.run_id }}

      - name: Verify AWS connection
        run: |
          echo "Testing AWS connection..."
          aws sts get-caller-identity
          echo "‚úÖ AWS authentication successful (OIDC)"

      - name: Install dependencies
        run: npm ci

      - name: Build CDK project
        run: |
          echo "üî® Building CDK project..."
          npm run build
          echo "‚úÖ CDK build completed"

      - name: CDK Synth
        run: |
          echo "üîç Running CDK synth..."
          npm run synth -- --context environment=${{ env.ENVIRONMENT }}
          echo "‚úÖ CDK synth completed"

      - name: Deploy Infrastructure
        run: |
          echo "üöÄ Deploying infrastructure with CDK..."
          npm run deploy -- --context environment=${{ env.ENVIRONMENT }} --require-approval never --all
          echo "‚úÖ Infrastructure deployment completed"

      - name: Deployment Summary
        run: |
          echo "üìä Deployment Summary"
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "Component: Infrastructure (AWS CDK)"
          echo "Status: ‚úÖ Success"
          echo "Authentication: OIDC"

  # Frontend Web Deployment Job (OIDC)
  deploy-frontend-web:
    name: Deploy Frontend Web
    runs-on: ubuntu-latest
    if: ${{ inputs.deploy_frontend_web }}
    # OIDCË™çË®º„Å´ÂøÖË¶Å„Å™Ê®©Èôê
    permissions:
      id-token: write
      contents: read
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: frontend/.nvmrc
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Configure AWS credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_ARN }}
          aws-region: ${{ env.AWS_REGION }}
          role-session-name: GitHubActions-FrontendWeb-${{ github.run_id }}

      - name: Verify AWS connection
        run: |
          echo "Testing AWS connection..."
          aws sts get-caller-identity
          echo "‚úÖ AWS authentication successful (OIDC)"

      - name: Install dependencies
        run: npm ci

      - name: Build and Deploy Frontend Web
        run: |
          echo "üöÄ Building and deploying Frontend Web to S3..."
          cd ..
          make web-build-deploy
          echo "‚úÖ Frontend Web deployment completed"

      - name: Deployment Summary
        run: |
          echo "üìä Deployment Summary"
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "Component: Frontend Web (Expo Web -> S3 + CloudFront)"
          echo "Status: ‚úÖ Success"
          echo "Authentication: OIDC"

  # Frontend Mobile Build Job
  build-frontend-mobile:
    name: Build Frontend Mobile
    runs-on: ubuntu-latest
    if: ${{ inputs.build_frontend_mobile }}
    defaults:
      run:
        working-directory: ./frontend

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version-file: frontend/.nvmrc
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Setup EAS CLI
        run: npm install -g eas-cli

      - name: EAS Build (Android)
        env:
          EXPO_TOKEN: ${{ secrets.EXPO_TOKEN }}
        run: |
          echo "üöÄ Starting EAS Build for Android..."
          echo "Platform: android"
          echo "Profile: preview"
          echo "Project: janlog (wfigo7)"
          echo ""

          # EAS Build„ÇíÂÆüË°å„Åó„Å¶JSONÂá∫Âäõ„ÇíÂèñÂæó
          BUILD_OUTPUT=$(eas build --platform android --profile preview --non-interactive --json 2>&1 || true)

          echo "$BUILD_OUTPUT"

          # „Éì„É´„ÉâID„ÇíÊäΩÂá∫ÔºàJSONÂΩ¢Âºè„ÅÆÂ†¥ÂêàÔºâ
          BUILD_ID=$(echo "$BUILD_OUTPUT" | grep -o '"id":"[^"]*"' | head -1 | cut -d'"' -f4 || echo "")

          if [ -n "$BUILD_ID" ]; then
            echo ""
            echo "‚úÖ EAS Build submitted successfully"
            echo "Build ID: $BUILD_ID"
            echo "BUILD_ID=$BUILD_ID" >> $GITHUB_ENV
          else
            echo ""
            echo "‚ö†Ô∏è Could not extract Build ID from output"
          fi

      - name: Build Summary
        run: |
          echo "üìä Build Summary"
          echo "Environment: ${{ env.ENVIRONMENT }}"
          echo "Component: Frontend Mobile (EAS Build)"
          echo "Platform: Android"
          echo "Profile: preview"
          echo "Status: ‚úÖ Build submitted"
          echo ""
          if [ -n "$BUILD_ID" ]; then
            echo "Build ID: $BUILD_ID"
            echo "Build URL: https://expo.dev/accounts/wfigo7/projects/janlog/builds/$BUILD_ID"
          fi
          echo ""
          echo "Check all builds at: https://expo.dev/accounts/wfigo7/projects/janlog/builds"
          echo ""
          echo "Note: Build may take 10-20 minutes to complete."
          echo "You will receive an email notification when the build is ready."
